<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Réservation avec Critères - Gestion Taxi Brousse</title>
  <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="css/ruang-admin.min.css" rel="stylesheet">
  <style>
    .seat-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin: 20px 0;
    }
    .seat-btn {
      padding: 15px;
      border: 2px solid #ddd;
      background: #fff;
      cursor: pointer;
      border-radius: 5px;
      font-weight: bold;
      transition: all 0.3s;
    }
    .seat-btn:hover:not(.occupied):not(.selected) {
      background: #e3f2fd;
      border-color: #2196F3;
    }
    .seat-btn.selected {
      box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.35);
      border-color: #28a745;
    }
    .seat-btn.occupied {
      background: #f44336;
      color: white;
      border-color: #f44336;
      cursor: not-allowed;
    }
    .seat-cat-vip {
      border-color: #d4af37;
      background: #fff8e1;
      color: #8a6d1f;
    }
    .seat-cat-premium {
      border-color: #8e44ad;
      background: #f3e5f5;
      color: #5e2a7a;
    }
    .seat-cat-standard {
      border-color: #3498db;
      background: #e3f2fd;
      color: #1b4f72;
    }
    .seat-btn.occupied.seat-cat-vip,
    .seat-btn.occupied.seat-cat-premium,
    .seat-btn.occupied.seat-cat-standard {
      background: #f44336;
      color: #fff;
    }
    .badge.seat-cat-vip {
      background: #fff8e1;
      color: #8a6d1f;
      border: 1px solid #d4af37;
    }
    .badge.seat-cat-premium {
      background: #f3e5f5;
      color: #5e2a7a;
      border: 1px solid #8e44ad;
    }
    .badge.seat-cat-standard {
      background: #e3f2fd;
      color: #1b4f72;
      border: 1px solid #3498db;
    }
    .depart-card {
      border-left: 4px solid #6777ef;
      cursor: pointer;
      transition: all 0.3s;
      overflow: hidden;
    }
    .depart-card:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    .depart-card .card-body {
      padding: 12px;
    }
    .badge-places {
      font-size: 0.9rem;
    }
    .calendar-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e3e6f0;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    .calendar-day-header {
      text-align: center;
      font-weight: bold;
      padding: 10px;
      background: #f8f9fc;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .calendar-day {
      min-height: 100px;
      border: 1px solid #e3e6f0;
      border-radius: 4px;
      padding: 8px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }
    .calendar-day:hover {
      background: #f8f9fc;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    .calendar-day.other-month {
      background: #fafbfc;
      color: #999;
    }
    .calendar-day.today {
      background: #e7f3ff;
      border-color: #4e73df;
    }
    .calendar-day.has-departs {
      background: #d1ecf1;
      border-color: #17a2b8;
    }
    .calendar-day.has-departs:hover {
      background: #bee5eb;
    }
    .day-number {
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 5px;
    }
    .departs-count {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #17a2b8;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: bold;
    }
    .places-indicator {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 15px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .places-disponibles {
      background: #d4edda;
      color: #155724;
    }
    .places-limitees {
      background: #fff3cd;
      color: #856404;
    }
    .places-completes {
      background: #f8d7da;
      color: #721c24;
    }
    .loading-spinner {
      display: none;
      text-align: center;
      padding: 40px;
    }
  </style>
</head>

<body id="page-top">
  <div id="wrapper">
    <!-- Sidebar -->
    <div th:replace="~{taxi_brousse/fragments :: sidebar}"></div>
    <ul class="navbar-nav sidebar sidebar-light accordion" id="accordionSidebar" style="display:none;">
      <a class="sidebar-brand d-flex align-items-center justify-content-center" href="/index">
        <div class="sidebar-brand-icon">
          <img src="/img/logo/logo2.png">
        </div>
        <div class="sidebar-brand-text mx-3">Taxi Brousse</div>
      </a>
      <hr class="sidebar-divider my-0">
      <li class="nav-item">
        <a class="nav-link" href="/index">
          <i class="fas fa-fw fa-tachometer-alt"></i>
          <span>Dashboard</span></a>
      </li>
      <hr class="sidebar-divider">
      <div class="sidebar-heading">Gestion</div>
      <li class="nav-item">
        <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseGestion"
          aria-expanded="true" aria-controls="collapseGestion">
          <i class="fas fa-fw fa-car"></i>
          <span>Transport</span>
        </a>
        <div id="collapseGestion" class="collapse" aria-labelledby="headingGestion" data-parent="#accordionSidebar">
          <div class="bg-white py-2 collapse-inner rounded">
            <h6 class="collapse-header">Gestion Transport</h6>
            <a class="collapse-item" href="/cooperatives">Coopératives</a>
            <a class="collapse-item" href="/vehicules">Véhicules</a>
            <a class="collapse-item" href="/chauffeurs">Chauffeurs</a>
            <a class="collapse-item" href="/trajets">Trajets</a>
            <a class="collapse-item" href="/lieux">Lieux</a>
          </div>
        </div>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/tarifs">
          <i class="fas fa-fw fa-dollar-sign"></i>
          <span>Tarifs</span>
        </a>
      </li>
      <li class="nav-item active">
        <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseReservation"
          aria-expanded="true" aria-controls="collapseReservation">
          <i class="fas fa-fw fa-ticket-alt"></i>
          <span>Réservations</span>
        </a>
        <div id="collapseReservation" class="collapse show" aria-labelledby="headingReservation"
          data-parent="#accordionSidebar">
          <div class="bg-white py-2 collapse-inner rounded">
            <h6 class="collapse-header">Réservations</h6>
            <a class="collapse-item" href="/clients">Clients</a>
            <a class="collapse-item" href="/reservations">Départs Disponibles</a>
            <a class="collapse-item" href="/reservations-liste">Liste Réservations</a>
            <a class="collapse-item active" href="/reservations-critere">Réservations avec critere</a>
            <a class="collapse-item" href="/departs">Départs</a>
            <a class="collapse-item" href="/billets">Billets</a>
          </div>
        </div>
      </li>
    </ul>
    <!-- End Sidebar -->

    <div id="content-wrapper" class="d-flex flex-column">
      <div id="content">
        <!-- TopBar -->
        <nav class="navbar navbar-expand navbar-light bg-navbar topbar mb-4 static-top">
          <button id="sidebarToggleTop" class="btn btn-link rounded-circle mr-3">
            <i class="fa fa-bars"></i>
          </button>
          <ul class="navbar-nav ml-auto">
            <li class="nav-item dropdown no-arrow">
              <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown">
                <img class="img-profile rounded-circle" src="img/boy.png" style="max-width: 60px">
                <span class="ml-2 d-none d-lg-inline text-white small">Administrateur</span>
              </a>
            </li>
          </ul>
        </nav>
        <!-- End TopBar -->

        <!-- Container Fluid-->
        <div class="container-fluid" id="container-wrapper">
          <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h3 mb-0 text-gray-800">Réservation avec Critères <span class="badge badge-info">Recherche Avancée</span></h1>
            <button class="btn btn-primary" data-toggle="modal" data-target="#nouvelleReservationModal">
              <i class="fas fa-plus"></i> Nouvelle Réservation
            </button>
          </div>

          <!-- Alert Messages -->
          <div id="alertContainer"></div>

          <!-- Calendrier des Départs -->
          <div class="row">
            <div class="col-lg-8">
              <div class="calendar-container">
                <div class="calendar-header">
                  <button id="prevMonth" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-chevron-left"></i> Précédent
                  </button>
                  <h4 id="currentMonth" class="mb-0"></h4>
                  <button id="nextMonth" class="btn btn-sm btn-outline-primary">
                    Suivant <i class="fas fa-chevron-right"></i>
                  </button>
                </div>
                <div class="calendar-grid">
                  <div class="calendar-day-header">Lun</div>
                  <div class="calendar-day-header">Mar</div>
                  <div class="calendar-day-header">Mer</div>
                  <div class="calendar-day-header">Jeu</div>
                  <div class="calendar-day-header">Ven</div>
                  <div class="calendar-day-header">Sam</div>
                  <div class="calendar-day-header">Dim</div>
                </div>
                <div id="calendarDays" class="calendar-grid mt-2"></div>
              </div>
            </div>

            <div class="col-lg-4">
              <div class="card">
                <div class="card-header py-3 bg-primary text-white">
                  <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-bus"></i> Départs <span id="selectedDate"></span>
                  </h6>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                  <div id="loading" class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                      <span class="sr-only">Chargement...</span>
                    </div>
                  </div>
                  <div id="departsContainer" style="display: none;">
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
        <!-- End Container Fluid -->
      </div>
      <!-- Footer -->
      <footer class="sticky-footer bg-white">
        <div class="container my-auto">
          <div class="copyright text-center my-auto">
            <span>&copy; 2026 Gestion Taxi Brousse</span>
          </div>
        </div>
      </footer>
    </div>
  </div>

  <!-- Modal Nouvelle Réservation -->
  <div class="modal fade" id="nouvelleReservationModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Nouvelle Réservation Avec critere</h5>
          <button type="button" class="close" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="reservationForm">
            <!-- Step 0: Client et Notes (pour sélection depuis calendrier) -->
            <div id="step0" style="display:none;">
              <div class="alert alert-info mb-3">
                <i class="fas fa-info-circle"></i> Départ sélectionné depuis le calendrier
              </div>
              <div id="departInfoResume" class="alert alert-secondary mb-3"></div>
              
              <h6 class="mb-3">Informations du Client</h6>
              <div class="form-group">
                <label>Client *</label>
                <select class="form-control" id="clientIdSimple">
                  <option value="">Sélectionnez un client</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>Notes</label>
                <textarea class="form-control" id="notesSimple" rows="2" placeholder="Notes additionnelles (optionnel)"></textarea>
              </div>
              
              <button type="button" class="btn btn-primary" onclick="goToStep2FromSimple()">Suivant : Sélection des places</button>
            </div>
            
            <!-- Step 1: Client et Départ -->
            <div id="step1">
              <h6 class="mb-3">Informations Générales</h6>
              <div class="form-group">
                <label>Client *</label>
                <select class="form-control" id="clientId">
                  <option value="">Sélectionnez un client</option>
                </select>
              </div>
              <div class="form-group">
                <label>Lieu de départ *</label>
                <select class="form-control" id="lieuDepartID">
                  <option value="">Sélectionnez un lieu de départ</option>
                </select>
              </div>

              <div class="form-group">
                <label>Lieu d'arrivée *</label>
                <select class="form-control" id="lieuArriveeID">
                  <option value="">Sélectionnez une arrivée</option>
                </select>
              </div>

              <div class="form-group">
                <label>Date de départ *</label>
                <input type="date" class="form-control" id="dateDepart">
              </div>

              <div class="form-group">
                <label>Heure de départ *</label>
                <input type="time" class="form-control" id="heureDepart">
              </div>

              <div id="departSelectionResume" class="alert alert-secondary" style="display:none;"></div>

              <div class="form-group">
                <label>Notes</label>
                <textarea class="form-control" id="notes" rows="2"></textarea>
              </div>
              <button type="button" class="btn btn-primary" onclick="goToStep2()">Suivant : Sélection des places</button>
            </div>

            <!-- Step 2: Selection des places -->
            <div id="step2" style="display:none;">
              <h6 class="mb-3">Sélection des Places</h6>
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Cliquez sur les sièges disponibles pour sélectionner les places.
              </div>
              <div id="seatInfo" class="mb-3">
                <span class="badge badge-success mr-2">
                  <i class="fas fa-circle"></i> Disponible
                </span>
                <span class="badge badge-danger mr-2">
                  <i class="fas fa-circle"></i> Occupé
                </span>
                <span class="badge badge-primary mr-2">
                  <i class="fas fa-circle"></i> Sélectionné
                </span>
              </div>
              <div id="seatsGrid" class="seat-grid"></div>
              
              <div id="passagersInfo" class="mt-4" style="display:none;">
                <div id="groupedSelectionSummary" class="mt-3"></div>
                <div id="groupSelectionPanel" class="mt-3"></div>
              </div>

              <div class="mt-3">
                <button type="button" class="btn btn-secondary" id="btnRetourStep2" onclick="goBackFromStep2()">Retour</button>
                <button type="button" class="btn btn-primary" id="nextToPayment" style="display:none;" onclick="goToStep3()">
                  Suivant : Paiement
                </button>
              </div>
            </div>

            <!-- Step 3: Paiement -->
            <div id="step3" style="display:none;">
              <h6 class="mb-3">Récapitulatif et Paiement</h6>
              
              <div class="alert alert-success">
                <h5>Montant total: <span id="montantTotalDisplay"></span></h5>
                <p class="mb-0"><strong>Nombre de passagers:</strong> <span id="nbPassagersDisplay"></span></p>
              </div>

              <div class="card mb-3">
                <div class="card-body">
                  <h6 class="mb-3">Tarifs par siège</h6>
                  <div class="table-responsive">
                    <table class="table table-sm table-hover">
                      <thead class="thead-light">
                        <tr>
                          <th>Siège</th>
                          <th>Catégorie siège</th>
                          <th>Catégorie passager</th>
                          <th>Tarif de base</th>
                          <th>Remise</th>
                          <th>Tarif à payer</th>
                        </tr>
                      </thead>
                      <tbody id="recapTarifsSiegesBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
              
              <div class="form-group">
                <label>Mode de paiement *</label>
                <select class="form-control" id="modePaiement" onchange="updatePaiementFields()" required>
                  <option value="">Sélectionnez un mode</option>
                  <option value="PAIEMENT_IMMEDIAT">Paiement immédiat</option>
                  <option value="COMPTOIR">Paiement au comptoir</option>
                  <option value="EMBARQUEMENT">Paiement à l'embarquement</option>
                </select>
              </div>
              
              <!-- Champs pour paiement immédiat -->
              <div id="paiementImmediatFields" style="display:none;">
                <div class="alert alert-info">
                  <i class="fas fa-info-circle"></i> Sélectionnez votre méthode de paiement
                </div>
                
                <div class="form-group">
                  <label>Méthode de paiement *</label>
                  <select class="form-control" id="methodePaiement" onchange="updateMethodeFields()">
                    <option value="">Sélectionnez une méthode</option>
                    <option value="ESPECES">Espèces</option>
                    <option value="MOBILE_MONEY">Mobile Money (MVola, Orange Money)</option>
                    <option value="CARTE_BANCAIRE">Carte bancaire</option>
                    <option value="CHEQUE">Chèque</option>
                  </select>
                </div>
                
                <!-- Champs Mobile Money -->
                <div id="mobileMoneyFields" style="display:none;">
                  <div class="form-group">
                    <label>Numéro de téléphone</label>
                    <input type="text" class="form-control" id="numeroTelephone" placeholder="Ex: 034 12 345 67">
                  </div>
                  <div class="form-group">
                    <label>Référence transaction</label>
                    <input type="text" class="form-control" id="referenceTransaction" placeholder="Code de transaction">
                  </div>
                </div>
                
                <!-- Champs Carte bancaire -->
                <div id="carteFields" style="display:none;">
                  <div class="form-group">
                    <label>Référence transaction</label>
                    <input type="text" class="form-control" id="refTransactionCarte" placeholder="Numéro d'autorisation">
                  </div>
                </div>
              </div>
              
              <!-- Info paiement différé -->
              <div id="paiementDiffereInfo" style="display:none;">
                <div class="alert alert-warning">
                  <i class="fas fa-exclamation-triangle"></i> 
                  <strong>Paiement différé</strong>
                  <p class="mb-0">Votre réservation sera créée avec le statut "En attente de paiement". 
                  Vous devrez effectuer le paiement <span id="lieuPaiement"></span>.</p>
                </div>
              </div>

              <div class="mt-3">
                <button type="button" class="btn btn-secondary" onclick="goBackToStep2()">Retour</button>
                <button type="submit" class="btn btn-success" id="submitReservation">
                  <i class="fas fa-check"></i> Confirmer la Réservation
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Details Réservation -->
  <div class="modal fade" id="detailsReservationModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Détails de la Réservation</h5>
          <button type="button" class="close" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body" id="detailsContent">
          <!-- Details will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
          <button type="button" class="btn btn-danger" id="annulerBtn" onclick="annulerReservation()">
            <i class="fas fa-times"></i> Annuler la Réservation
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- <script src="js/ruang-admin.min.js"></script> -->

  <script>
    let selectedSeats = [];
    let currentReservationId = null;
    let seatInfoByNumber = {};
    let passagerCategories = [];
    let remisesByCategorie = {};
    let departsDisponibles = [];
    let selectedDepartId = null;
    let clientsById = {};

    // Load page data
    $(document).ready(function() {
      loadClients();
      loadLieux();
      loadDepartsDisponibles();
      loadReservations();
      
      // Sidebar toggle
      $('#sidebarToggleTop').on('click', function() {
        $('body').toggleClass('sidebar-toggled');
        $('.sidebar').toggleClass('toggled');
      });
    });

    function loadClients() {
      $.get('/api/clients', function(clients) {
        const select = $('#clientId');
        clients.forEach(client => {
          clientsById[client.id] = client;
          select.append(`<option value="${client.id}">${client.nom} ${client.prenom || ''}</option>`);
        });
      });
    }

    function getSelectedClient() {
      const simpleId = $('#clientIdSimple').val();
      const mainId = $('#clientId').val();
      const id = simpleId ? parseInt(simpleId, 10) : parseInt(mainId, 10);
      return clientsById[id];
    }

    function loadLieux() {
      $.get('/api/lieux', function(lieux) {
        const departSelect = $('#lieuDepartID');
        const arriveeSelect = $('#lieuArriveeID');
        departSelect.find('option:not(:first)').remove();
        arriveeSelect.find('option:not(:first)').remove();
        lieux.forEach(lieu => {
          departSelect.append(`<option value="${lieu.id}">${lieu.nom}</option>`);
          arriveeSelect.append(`<option value="${lieu.id}">${lieu.nom}</option>`);
        });
      });
    }

    function loadDepartsDisponibles() {
      $.get('/api/departs/disponibles', function(departs) {
        const container = $('#departsContainer');
        container.empty();
        departsDisponibles = departs || [];

        if (departs.length === 0) {
          container.html('<div class="col-12"><p class="text-muted">Aucun départ disponible</p></div>');
          return;
        }

        departs.forEach(depart => {
          const dateDepart = new Date(depart.dateHeureDepart).toLocaleString('fr-FR');
          const placesRestantes = depart.placesDisponibles || 0;
          const badgeColor = placesRestantes > 5 ? 'success' : placesRestantes > 0 ? 'warning' : 'danger';

          container.append(`
            <div class="col-md-6 mb-3">
              <div class="card depart-card">
                <div class="card-body">
                  <h6 class="font-weight-bold">${depart.trajetLibelle}</h6>
                  <p class="mb-1"><i class="fas fa-calendar"></i> ${dateDepart}</p>
                  <p class="mb-1"><i class="fas fa-building"></i> ${depart.cooperativeNom}</p>
                  <p class="mb-1"><i class="fas fa-car"></i> ${depart.vehiculeImmatriculation}</p>
                  <span class="badge badge-${badgeColor} badge-places">
                    ${placesRestantes} places disponibles / ${depart.nombrePlaces}
                  </span>
                </div>
              </div>
            </div>
          `);

        });
      });
    }

    function loadReservations() {
      $.get('/api/reservations', function(reservations) {
        const tbody = $('#reservationsTableBody');
        tbody.empty();

        reservations.forEach(res => {
          const dateDepart = new Date(res.dateHeureDepart).toLocaleString('fr-FR');
          const nbPassagers = res.passagers ? res.passagers.length : 0;
          const sieges = res.passagers ? res.passagers.map(p => p.numeroSiege).join(', ') : '';
          
          let statutBadge = 'secondary';
          if (res.refReservationStatutLibelle === 'Confirmé' || res.refReservationStatutLibelle === 'CONFIRME') statutBadge = 'success';
          else if (res.refReservationStatutLibelle === 'Annulé' || res.refReservationStatutLibelle === 'ANNULE') statutBadge = 'danger';
          else if (res.refReservationStatutLibelle === 'En attente') statutBadge = 'warning';

          tbody.append(`
            <tr>
              <td>${res.code}</td>
              <td>${res.clientNom} ${res.clientPrenom || ''}</td>
              <td>${res.departCode}</td>
              <td>${res.trajetLibelle}</td>
              <td>${dateDepart}</td>
              <td><span class="badge badge-info">${nbPassagers} passager(s)</span><br><small>Sièges: ${sieges}</small></td>
              <td><span class="badge badge-${statutBadge}">${res.refReservationStatutLibelle}</span></td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="viewDetails(${res.id})">
                  <i class="fas fa-eye"></i>
                </button>
              </td>
            </tr>
          `);
        });
      });
    }

    function goToStep2() {
      const lieuDepartId = $('#lieuDepartID').val();
      const lieuArriveeId = $('#lieuArriveeID').val();
      const dateDepart = $('#dateDepart').val();
      const heureDepart = $('#heureDepart').val();

      if (!lieuDepartId || !lieuArriveeId || !dateDepart || !heureDepart) {
        showAlert('Veuillez renseigner lieu de départ, lieu d\'arrivée, date et heure', 'warning');
        return;
      }

      const matches = departsDisponibles.filter(d => {
        if (!d.lieuDepartId || !d.lieuArriveeId || !d.dateHeureDepart) return false;
        const parts = d.dateHeureDepart.split('T');
        const dDate = parts[0];
        const dTime = parts[1] ? parts[1].substring(0,5) : '';
        return String(d.lieuDepartId) === String(lieuDepartId)
          && String(d.lieuArriveeId) === String(lieuArriveeId)
          && dDate === dateDepart
          && dTime === heureDepart;
      });

      if (matches.length === 0) {
        showAlert('Aucun départ ne correspond à ces critères', 'warning');
        return;
      }

      // Prendre le premier départ correspondant (le plus pertinent si plusieurs)
      const depart = matches[0];
      selectedDepartId = depart.id;

      $('#departSelectionResume').show().html(`
        <strong>Départ sélectionné :</strong> ${depart.code} - ${depart.trajetLibelle} (${depart.cooperativeNom || ''})<br>
        ${new Date(depart.dateHeureDepart).toLocaleString('fr-FR')}<br>
        Lieux : ${depart.lieuDepartNom || ''} → ${depart.lieuArriveeNom || ''}
      `);

      $.when(
        $.get(`/api/departs/${selectedDepartId}/seat-map`),
        $.get('/api/reference/passager-categories'),
        $.get(`/api/departs/${selectedDepartId}/remises-passagers`)
      ).done(function(seatsRes, categoriesRes, remisesRes) {
        const seats = seatsRes[0];
        passagerCategories = categoriesRes[0] || [];
        remisesByCategorie = buildRemisesMap(remisesRes[0] || []);

        if (!seats || seats.length === 0) {
          showAlert('Aucune configuration de sièges ou tarifs pour ce départ', 'danger');
          return;
        }

        $('#step1').hide();
        $('#step2').show();
        renderSeats(seats);
      }).fail(function(xhr) {
        console.error('Erreur seat map:', xhr);
        const error = xhr.responseJSON ? xhr.responseJSON.message : 'Impossible de récupérer les sièges';
        showAlert(error, 'danger');
      });
    }

    function goToStep1() {
      $('#step2').hide();
      $('#step1').show();
      selectedSeats = [];
      selectedDepartId = null;
      $('#departSelectionResume').hide().empty();
    }

    function renderSeats(seats) {
      const grid = $('#seatsGrid');
      grid.empty();
      selectedSeats = [];
      seatInfoByNumber = {};

      const sortedSeats = seats.sort((a, b) => a.numeroSiege - b.numeroSiege);
      renderSeatLegend(sortedSeats);

      sortedSeats.forEach(seat => {
        seatInfoByNumber[seat.numeroSiege] = seat;
        const isAvailable = seat.disponible;
        const categoryClass = getCategoryClass(seat.refSiegeCategorieCode);
        const className = isAvailable ? `seat-btn ${categoryClass}` : `seat-btn ${categoryClass} occupied`;
        const disabled = !isAvailable ? 'disabled' : '';
        const priceLabel = seat.montant ? formatMoney(seat.montant, seat.deviseCode) : '';

        const btn = $(`
          <button type="button" class="${className}" ${disabled} data-seat="${seat.numeroSiege}" data-category="${seat.refSiegeCategorieCode}">
            <i class="fas fa-chair"></i><br>Siège ${seat.numeroSiege}
            <div><small>${seat.refSiegeCategorieLibelle || ''}</small></div>
            <div><small>${priceLabel}</small></div>
          </button>
        `);

        if (isAvailable) {
          btn.on('click', function() {
            toggleSeat(seat.numeroSiege, $(this));
          });
        }

        grid.append(btn);
      });
    }

    function getCategoryClass(code) {
      if (!code) return '';
      return `seat-cat-${code.toLowerCase()}`;
    }

    function formatMoney(amount, deviseCode) {
      const num = Number(amount || 0);
      return num.toLocaleString('fr-FR', { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + ' ' + (deviseCode || '');
    }

    function renderSeatLegend(seats) {
      const legend = $('#seatInfo');
      const categories = {};
      seats.forEach(seat => {
        if (!categories[seat.refSiegeCategorieCode]) {
          categories[seat.refSiegeCategorieCode] = seat;
        }
      });

      let html = `
        <span class="badge badge-success mr-2">
          <i class="fas fa-circle"></i> Disponible
        </span>
        <span class="badge badge-danger mr-2">
          <i class="fas fa-circle"></i> Occupé
        </span>
        <span class="badge badge-primary mr-2">
          <i class="fas fa-circle"></i> Sélectionné
        </span>
      `;

      Object.values(categories).forEach(cat => {
        const className = getCategoryClass(cat.refSiegeCategorieCode);
        const priceLabel = cat.montant ? formatMoney(cat.montant, cat.deviseCode) : '';
        html += `
          <span class="badge badge-light mr-2 ${className}">
            ${cat.refSiegeCategorieLibelle || cat.refSiegeCategorieCode} - ${priceLabel}
          </span>
        `;
      });

      legend.html(html);
    }

    function toggleSeat(seatNumber, btn) {
      const index = selectedSeats.indexOf(seatNumber);

      if (index > -1) {
        selectedSeats.splice(index, 1);
        btn.removeClass('selected');
      } else {
        selectedSeats.push(seatNumber);
        btn.addClass('selected');
      }

      if (selectedSeats.length > 0) {
        showPassagersForms();
      } else {
        $('#passagersInfo').hide();
        $('#nextToPayment').hide();
      }
    }

    function showPassagersForms() {
      renderGroupedSelection();
      renderGroupSelectionPanel();
      updateSeatCategoryLabels();

      $('#passagersInfo').show();
      $('#nextToPayment').show();
    }

    function ensureHiddenCategoryInputs() {
      const container = $('#groupSelectionPanel');
      if (container.find('.passager-categorie').length > 0) {
        return;
      }
      const categoriesOptions = passagerCategories.map(c => `<option value="${c.id}">${c.libelle}</option>`).join('');
      const hidden = selectedSeats.map(seat => {
        return `
          <select class="form-control passager-categorie d-none" data-seat="${seat}" required>
            <option value="">Sélectionner</option>
            ${categoriesOptions}
          </select>
          <span class="passager-categorie-label d-none" data-seat="${seat}"></span>
        `;
      }).join('');
      container.append(`<div class="d-none" id="hiddenPassagerCategories">${hidden}</div>`);
    }

    function getSeatCategoryGroups() {
      const groups = {};
      selectedSeats.forEach(seat => {
        const info = seatInfoByNumber[seat] || {};
        const catId = info.refSiegeCategorieId;
        if (!catId) {
          return;
        }
        if (!groups[catId]) {
          groups[catId] = {
            catId,
            label: info.refSiegeCategorieLibelle || info.refSiegeCategorieCode || 'Catégorie',
            seats: []
          };
        }
        groups[catId].seats.push(seat);
      });
      return Object.values(groups).sort((a, b) => a.label.localeCompare(b.label));
    }

    function renderGroupSelectionPanel() {
      const panel = $('#groupSelectionPanel');
      const seatGroups = getSeatCategoryGroups();

      if (seatGroups.length === 0 || passagerCategories.length === 0) {
        panel.html('');
        return;
      }

      const headerCols = passagerCategories.map(c => `<th class="text-center">${c.libelle}</th>`).join('');
      const rows = seatGroups.map(g => {
        const inputs = passagerCategories.map(c => {
          return `
            <td class="text-center">
              <input type="number" min="0" class="form-control form-control-sm group-qty"
                data-seatcat-id="${g.catId}" data-passcat-id="${c.id}" value="0">
            </td>
          `;
        }).join('');

        return `
          <tr data-seatcat-id="${g.catId}" data-max="${g.seats.length}">
            <td><strong>${g.label}</strong></td>
            <td class="text-center">${g.seats.length}</td>
            ${inputs}
          </tr>
        `;
      }).join('');

      panel.html(`
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Groupage par catégories</h6>
              <button type="button" class="btn btn-sm btn-outline-primary" id="groupApplyBtn" onclick="applyGroupedSelection()">
                Appliquer le groupage
              </button>
            </div>
            <div class="table-responsive">
              <table class="table table-sm table-bordered mb-0">
                <thead class="thead-light">
                  <tr>
                    <th>Catégorie siège</th>
                    <th class="text-center">Places</th>
                    ${headerCols}
                  </tr>
                </thead>
                <tbody>
                  ${rows}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `);
      ensureHiddenCategoryInputs();
      bindGroupQuantityValidation();
    }

    function bindGroupQuantityValidation() {
      const panel = $('#groupSelectionPanel');
      panel.off('input', '.group-qty');
      panel.on('input', '.group-qty', function() {
        const row = $(this).closest('tr');
        const max = parseInt(row.data('max'), 10) || 0;
        let sum = 0;
        row.find('.group-qty').each(function() {
          sum += parseInt($(this).val(), 10) || 0;
        });
        if (sum > max) {
          row.addClass('table-danger');
        } else {
          row.removeClass('table-danger');
        }
        const hasError = panel.find('tr.table-danger').length > 0;
        $('#groupApplyBtn').prop('disabled', hasError);
      });
    }

    function applyGroupedSelection() {
      const seatGroups = getSeatCategoryGroups();

      for (const group of seatGroups) {
        const inputs = $(`.group-qty[data-seatcat-id="${group.catId}"]`);
        let totalQty = 0;
        const assignments = [];

        inputs.each(function() {
          const qty = parseInt($(this).val(), 10) || 0;
          const passCatId = parseInt($(this).data('passcat-id'), 10);
          totalQty += qty;
          if (qty > 0) {
            assignments.push({ passCatId, qty });
          }
        });

        if (totalQty !== group.seats.length) {
          showAlert(`Le total pour ${group.label} doit être ${group.seats.length} place(s).`, 'warning');
          return;
        }

        let seatIndex = 0;
        assignments.forEach(a => {
          for (let i = 0; i < a.qty; i += 1) {
            const seat = group.seats[seatIndex];
            $(`.passager-categorie[data-seat="${seat}"]`).val(String(a.passCatId));
            seatIndex += 1;
          }
        });
      }

      renderGroupedSelection();
      updateSeatCategoryLabels();
    }

    function updateSeatCategoryLabels() {
      selectedSeats.forEach(seat => {
        const passagerCategorieId = parseInt($(`.passager-categorie[data-seat="${seat}"]`).val(), 10);
        const passagerCategorie = passagerCategories.find(c => String(c.id) === String(passagerCategorieId));
        const label = passagerCategorie ? passagerCategorie.libelle : 'Non défini';
        $(`.passager-categorie-label[data-seat="${seat}"]`).text(label);
      });
    }

    function renderGroupedSelection() {
      const summary = $('#groupedSelectionSummary');
      const groups = {};

      selectedSeats.forEach(seat => {
        const info = seatInfoByNumber[seat] || {};
        const catSiegeLabel = info.refSiegeCategorieLibelle || info.refSiegeCategorieCode || 'Catégorie';
        const passagerCategorieId = parseInt($(`.passager-categorie[data-seat="${seat}"]`).val(), 10);
        const passagerCategorie = passagerCategories.find(c => String(c.id) === String(passagerCategorieId));
        const passagerLabel = passagerCategorie ? passagerCategorie.libelle : 'Non défini';
        const key = `${catSiegeLabel}__${passagerLabel}`;

        if (!groups[key]) {
          groups[key] = { catSiegeLabel, passagerLabel, count: 0 };
        }
        groups[key].count += 1;
      });

      const items = Object.values(groups).sort((a, b) => {
        const aKey = `${a.catSiegeLabel}-${a.passagerLabel}`;
        const bKey = `${b.catSiegeLabel}-${b.passagerLabel}`;
        return aKey.localeCompare(bKey);
      });

      if (items.length === 0) {
        summary.html('');
        return;
      }

      summary.html(`
        <div class="alert alert-light mb-0">
          <strong>Groupage par catégorie:</strong>
          <ul class="mb-0">
            ${items.map(i => `<li>${i.catSiegeLabel} / ${i.passagerLabel} : ${i.count} place(s)</li>`).join('')}
          </ul>
        </div>
      `);
    }

    function buildRemisesMap(remises) {
      const map = {};
      (remises || []).forEach(r => {
        if (!map[r.refSiegeCategorieId]) {
          map[r.refSiegeCategorieId] = {};
        }
        map[r.refSiegeCategorieId][r.refPassagerCategorieId] = r;
      });
      return map;
    }

    function computeDiscountedAmount(info, passagerCategorieId) {
      if (!info || !info.montant) {
        return 0;
      }
      const remisesParPassager = remisesByCategorie[info.refSiegeCategorieId] || {};
      const remise = remisesParPassager[passagerCategorieId];
      let montant = Number(info.montant) || 0;
      if (!remise) {
        return montant;
      }
      let finalMontant = Number(remise.montant) || 0;
      if ((remise.typeRemise || '').toUpperCase() === 'POURCENT') {
        finalMontant = montant - (montant * (finalMontant / 100));
      }
      return finalMontant < 0 ? 0 : finalMontant;
    }

    function computeMontantTotal() {
      return selectedSeats.reduce((sum, seat) => {
        const info = seatInfoByNumber[seat];
        const passagerCategorieId = parseInt($(`.passager-categorie[data-seat="${seat}"]`).val(), 10);
        return sum + computeDiscountedAmount(info, passagerCategorieId);
      }, 0);
    }

    function renderTarifsRecap() {
      const tbody = $('#recapTarifsSiegesBody');
      tbody.empty();

      selectedSeats.sort((a, b) => a - b).forEach(seat => {
        const info = seatInfoByNumber[seat] || {};
        const passagerCategorieId = parseInt($(`.passager-categorie[data-seat="${seat}"]`).val(), 10);
        const passagerCategorie = passagerCategories.find(c => String(c.id) === String(passagerCategorieId));

        const baseLabel = info.montant ? formatMoney(info.montant, info.deviseCode) : '-';
        const finalAmount = computeDiscountedAmount(info, passagerCategorieId);
        const finalLabel = formatMoney(finalAmount, info.deviseCode);

        let remiseLabel = 'Aucune';
        let badge = '';
        const remisesParPassager = remisesByCategorie[info.refSiegeCategorieId] || {};
        const remise = remisesParPassager[passagerCategorieId];
        if (remise) {
          if ((remise.typeRemise || '').toUpperCase() === 'POURCENT') {
            remiseLabel = `${remise.montant}%`;
          } else {
            remiseLabel = `${formatMoney(remise.montant, info.deviseCode)} (tarif fixé)`;
          }
          badge = ' <span class="badge badge-success">Remise appliquée</span>';
        }

        const siegeLabel = info.refSiegeCategorieLibelle || info.refSiegeCategorieCode || '';
        const passagerLabel = passagerCategorie ? passagerCategorie.libelle : '';

        tbody.append(`
          <tr>
            <td>${seat}</td>
            <td>${siegeLabel}</td>
            <td>${passagerLabel}</td>
            <td>${baseLabel}</td>
            <td>${remiseLabel}${badge}</td>
            <td><strong>${finalLabel}</strong></td>
          </tr>
        `);
      });
    }
    
    function goToStep3() {
      // Valider que toutes les catégories passager sont renseignées
      let valid = true;
      selectedSeats.forEach(seat => {
        const categorie = $(`.passager-categorie[data-seat="${seat}"]`).val();
        if (!categorie) {
          valid = false;
        }
      });
      
      if (!valid) {
        showAlert('Veuillez sélectionner la catégorie de tous les passagers', 'warning');
        return;
      }
      
      // Charger le tarif et calculer le montant
      if (!selectedDepartId) {
        showAlert('Départ introuvable. Revenez à l\'étape précédente.', 'danger');
        return;
      }

      const montantTotal = computeMontantTotal();

      const firstSeat = seatInfoByNumber[selectedSeats[0]] || {};
      const deviseCode = firstSeat.deviseCode || '';

      $('#montantTotalDisplay').text(montantTotal.toLocaleString('fr-FR') + ' ' + deviseCode);
      $('#nbPassagersDisplay').text(selectedSeats.length);

      renderTarifsRecap();
      
      $('#step2').hide();
      $('#step3').show();
    }
    
    function goBackToStep2() {
      $('#step3').hide();
      $('#step2').show();
    }
    
    function updatePaiementFields() {
      const mode = $('#modePaiement').val();
      
      if (mode === 'PAIEMENT_IMMEDIAT') {
        $('#paiementImmediatFields').show();
        $('#paiementDiffereInfo').hide();
      } else if (mode === 'COMPTOIR') {
        $('#paiementImmediatFields').hide();
        $('#paiementDiffereInfo').show();
        $('#lieuPaiement').text('au comptoir avant le départ');
      } else if (mode === 'EMBARQUEMENT') {
        $('#paiementImmediatFields').hide();
        $('#paiementDiffereInfo').show();
        $('#lieuPaiement').text('lors de l\'embarquement');
      } else {
        $('#paiementImmediatFields').hide();
        $('#paiementDiffereInfo').hide();
      }
    }
    
    function updateMethodeFields() {
      const methode = $('#methodePaiement').val();
      $('#mobileMoneyFields').hide();
      $('#carteFields').hide();
      
      if (methode === 'MOBILE_MONEY') {
        $('#mobileMoneyFields').show();
      } else if (methode === 'CARTE_BANCAIRE') {
        $('#carteFields').show();
      }
    }

    $('#reservationForm').submit(function(e) {
      e.preventDefault();

      const passagers = [];
      let valid = true;

      const client = getSelectedClient();
      if (!client) {
        showAlert('Veuillez sélectionner un client', 'warning');
        return;
      }

      selectedSeats.forEach(seat => {
        const categorieId = parseInt($(`.passager-categorie[data-seat="${seat}"]`).val(), 10);

        if (!categorieId) {
          valid = false;
          showAlert('Veuillez sélectionner la catégorie de tous les passagers', 'warning');
          return false;
        }

        passagers.push({
          nom: client.nom,
          prenom: client.prenom || null,
          numeroSiege: seat,
          refPassagerCategorieId: categorieId
        });
      });

      if (!valid) return;
      
      const modePaiement = $('#modePaiement').val();
      if (!modePaiement) {
        showAlert('Veuillez sélectionner un mode de paiement', 'warning');
        return;
      }

      const data = {
        clientId: parseInt($('#clientId').val()),
        departId: selectedDepartId,
        notes: $('#notes').val() || null,
        passagers: passagers,
        modePaiement: modePaiement
      };
      
      // Ajouter les infos de paiement si paiement immédiat
      if (modePaiement === 'PAIEMENT_IMMEDIAT') {
        const methode = $('#methodePaiement').val();
        if (!methode) {
          showAlert('Veuillez sélectionner une méthode de paiement', 'warning');
          return;
        }
        
        const montantTotal = computeMontantTotal();
        data.paiementInfo = {
          montant: montantTotal,
          modePaiement: methode,
          numeroTelephone: $('#numeroTelephone').val() || null,
          referenceTransaction: $('#referenceTransaction').val() || $('#refTransactionCarte').val() || null
        };
      }

      $.ajax({
        url: '/api/reservations',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
          const message = modePaiement === 'PAIEMENT_IMMEDIAT' 
            ? 'Réservation créée et payée avec succès!' 
            : 'Réservation créée avec succès! N\'oubliez pas d\'effectuer le paiement.';
          showAlert(message, 'success');
          $('#nouvelleReservationModal').modal('hide');
          $('#reservationForm')[0].reset();
          goToStep1();
          loadReservations();
          loadDepartsDisponibles();
        },
        error: function(xhr) {
          const error = xhr.responseJSON ? xhr.responseJSON.message : 'Erreur lors de la création';
          showAlert(error, 'danger');
        }
      });
    });

    function viewDetails(id) {
      $.get(`/api/reservations/${id}`, function(reservation) {
        currentReservationId = id;
        const dateDepart = new Date(reservation.dateHeureDepart).toLocaleString('fr-FR');
        const passagersList = reservation.passagers.map(p => 
          `<li>Siège ${p.numeroSiege}: ${p.nom} ${p.prenom || ''}</li>`
        ).join('');

        $('#detailsContent').html(`
          <p><strong>Code:</strong> ${reservation.code}</p>
          <p><strong>Client:</strong> ${reservation.clientNom} ${reservation.clientPrenom || ''}</p>
          <p><strong>Départ:</strong> ${reservation.departCode}</p>
          <p><strong>Trajet:</strong> ${reservation.trajetLibelle}</p>
          <p><strong>Date de départ:</strong> ${dateDepart}</p>
          <p><strong>Statut:</strong> <span class="badge badge-success">${reservation.refReservationStatutLibelle}</span></p>
          <p><strong>Passagers:</strong></p>
          <ul>${passagersList}</ul>
          ${reservation.notes ? `<p><strong>Notes:</strong> ${reservation.notes}</p>` : ''}
        `);

        $('#detailsReservationModal').modal('show');
      });
    }

    function annulerReservation() {
      if (!currentReservationId) return;

      if (confirm('Êtes-vous sûr de vouloir annuler cette réservation?')) {
        $.ajax({
          url: `/api/reservations/${currentReservationId}/annuler`,
          method: 'PUT',
          success: function() {
            showAlert('Réservation annulée avec succès!', 'success');
            $('#detailsReservationModal').modal('hide');
            loadReservations();
            loadDepartsDisponibles();
          },
          error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.message : 'Erreur lors de l\'annulation';
            showAlert(error, 'danger');
          }
        });
      }
    }

    function showAlert(message, type) {
      const alert = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
          </button>
        </div>
      `;
      $('#alertContainer').html(alert);
      setTimeout(() => $('#alertContainer').empty(), 5000);
    }

    // ========== CALENDRIER ==========
    let currentDate = new Date();
    let departsCache = {};

    $(document).ready(function() {
      renderCalendar();
      loadDepartsForMonth();
    });

    $('#prevMonth').click(function() {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
      loadDepartsForMonth();
    });

    $('#nextMonth').click(function() {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
      loadDepartsForMonth();
    });

    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                        'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
      $('#currentMonth').text(monthNames[month] + ' ' + year);
      
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      
      let startDay = firstDay.getDay();
      startDay = startDay === 0 ? 6 : startDay - 1;
      
      $('#calendarDays').empty();
      
      const prevMonthDays = new Date(year, month, 0).getDate();
      for (let i = startDay - 1; i >= 0; i--) {
        const day = prevMonthDays - i;
        $('#calendarDays').append(createDayElement(day, true, null));
      }
      
      const today = new Date();
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const date = new Date(year, month, day);
        const isToday = date.toDateString() === today.toDateString();
        const dateStr = formatDate(date);
        $('#calendarDays').append(createDayElement(day, false, dateStr, isToday));
      }
      
      const totalCells = $('#calendarDays').children().length;
      const remainingCells = 42 - totalCells;
      for (let day = 1; day <= remainingCells; day++) {
        $('#calendarDays').append(createDayElement(day, true, null));
      }
    }

    function createDayElement(day, isOtherMonth, dateStr, isToday = false) {
      let classes = 'calendar-day';
      if (isOtherMonth) classes += ' other-month';
      if (isToday) classes += ' today';
      
      const hasDeparts = dateStr && departsCache[dateStr] && departsCache[dateStr].length > 0;
      if (hasDeparts) classes += ' has-departs';
      
      const countBadge = hasDeparts ? 
        `<div class="departs-count">${departsCache[dateStr].length}</div>` : '';
      
      const onclick = isOtherMonth ? '' : `onclick="selectDate('${dateStr}')"`;
      
      return `
        <div class="${classes}" ${onclick} data-date="${dateStr}">
          <div class="day-number">${day}</div>
          ${countBadge}
        </div>
      `;
    }

    function loadDepartsForMonth() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      
      const dateDebut = formatDate(firstDay);
      const dateFin = formatDate(lastDay);
      
      $.ajax({
        url: `/api/departs/par-date?dateDebut=${dateDebut}&dateFin=${dateFin}`,
        method: 'GET',
        success: function(departs) {
          departsCache = {};
          departs.forEach(depart => {
            const date = depart.dateHeureDepart.split('T')[0];
            if (!departsCache[date]) {
              departsCache[date] = [];
            }
            departsCache[date].push(depart);
          });
          renderCalendar();
        },
        error: function(xhr) {
          console.error('Erreur lors du chargement des départs', xhr);
        }
      });
    }

    function selectDate(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      $('#selectedDate').text(date.toLocaleDateString('fr-FR', options));
      
      $('#loading').show();
      $('#departsContainer').hide();
      
      $.ajax({
        url: `/api/departs/par-jour?date=${dateStr}`,
        method: 'GET',
        success: function(departs) {
          $('#loading').hide();
          $('#departsContainer').show();
          
          if (departs.length === 0) {
            $('#departsContainer').html(`
              <div class="text-center text-muted py-5">
                <i class="fas fa-calendar-times fa-3x mb-3"></i>
                <p>Aucun départ disponible pour cette date</p>
              </div>
            `);
          } else {
            let html = '';
            departs.forEach(depart => {
              html += createDepartCard(depart);
            });
            $('#departsContainer').html(html);
          }
        },
        error: function(xhr) {
          $('#loading').hide();
          $('#departsContainer').show().html(`
            <div class="alert alert-danger">
              Erreur lors du chargement des départs
            </div>
          `);
        }
      });
    }

    function createDepartCard(depart) {
      const dateTime = new Date(depart.dateHeureDepart);
      const time = dateTime.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
      
      const placesOccupees = depart.placesOccupees || 0;
      const placesTotal = depart.nombrePlaces;
      const placesDisponibles = placesTotal - placesOccupees;
      const tauxOccupation = (placesOccupees / placesTotal) * 100;
      
      let placesClass = 'places-disponibles';
      let placesIcon = 'fa-check-circle';
      if (tauxOccupation >= 80) {
        placesClass = 'places-limitees';
        placesIcon = 'fa-exclamation-circle';
      }
      if (placesDisponibles === 0) {
        placesClass = 'places-completes';
        placesIcon = 'fa-times-circle';
      }
      
      return `
        <div class="card depart-card mb-3" onclick="selectDepartForReservation(${depart.id})">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="flex-grow-1">
                <h6 class="mb-1">
                  <i class="fas fa-clock text-primary"></i> ${time}
                  <span class="badge badge-info ml-2">${depart.code}</span>
                </h6>
                <p class="mb-1 text-muted small">
                  <i class="fas fa-building"></i> ${depart.cooperativeNom}
                </p>
              </div>
              <span class="badge badge-${getStatusBadgeClass(depart.refDepartStatutCode)} ml-2">
                ${depart.refDepartStatutLibelle}
              </span>
            </div>
            
            <div class="mb-2">
              <small>
                <i class="fas fa-map-marker-alt text-success"></i>
                <strong>${depart.lieuDepartNom}</strong>
                <i class="fas fa-arrow-right mx-2 text-muted"></i>
                <i class="fas fa-map-marker-alt text-danger"></i>
                <strong>${depart.lieuArriveeNom}</strong>
              </small>
            </div>
            
            <div class="d-flex justify-content-between align-items-center flex-wrap">
              <small class="text-muted mb-1">
                <i class="fas fa-car"></i> ${depart.vehiculeImmatriculation}
              </small>
              <span class="places-indicator ${placesClass} mb-1">
                <i class="fas ${placesIcon} mr-1"></i>
                ${placesDisponibles} / ${placesTotal} places
              </span>
            </div>
          </div>
        </div>
      `;
    }

    function selectDepartForReservation(departId) {
      selectedDepartId = departId;
      
      // Charger les informations du départ
      $.get(`/api/departs/${departId}`, function(depart) {
        const dateTime = new Date(depart.dateHeureDepart);
        const date = dateTime.toLocaleDateString('fr-FR');
        const time = dateTime.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
        
        $('#departInfoResume').html(`
          <div class="row">
            <div class="col-md-6">
              <strong>Trajet:</strong> ${depart.lieuDepartNom} → ${depart.lieuArriveeNom}<br>
              <strong>Date:</strong> ${date} à ${time}
            </div>
            <div class="col-md-6">
              <strong>Véhicule:</strong> ${depart.vehiculeImmatriculation}<br>
              <strong>Coopérative:</strong> ${depart.cooperativeNom}
            </div>
          </div>
        `);
        
        // Charger les clients
        $.get('/api/clients', function(clients) {
          $('#clientIdSimple').html('<option value="">Sélectionnez un client</option>');
          clients.forEach(client => {
            clientsById[client.id] = client;
            $('#clientIdSimple').append(`<option value="${client.id}">${client.nom} ${client.prenom || ''}</option>`);
          });
        });
        
        $('#nouvelleReservationModal').modal('show');
        $('#step0').show();
        $('#step1').hide();
        $('#step2').hide();
        $('#step3').hide();
      });
    }

    function goToStep2FromSimple() {
      const clientId = $('#clientIdSimple').val();
      if (!clientId) {
        showAlert('Veuillez sélectionner un client', 'warning');
        return;
      }
      
      // Copier les valeurs dans les champs principaux
      $('#clientId').val(clientId);
      $('#notes').val($('#notesSimple').val());
      
      // Charger les informations du départ et la carte des sièges
      $.get(`/api/departs/${selectedDepartId}`, function(depart) {
        $('#departSelectionResume').show().html(`
          <strong>Départ sélectionné :</strong> ${depart.code} - ${depart.trajetLibelle} (${depart.cooperativeNom || ''})<br>
          ${new Date(depart.dateHeureDepart).toLocaleString('fr-FR')}<br>
          Lieux : ${depart.lieuDepartNom || ''} → ${depart.lieuArriveeNom || ''}
        `);

        $.when(
          $.get(`/api/departs/${selectedDepartId}/seat-map`),
          $.get('/api/reference/passager-categories'),
          $.get(`/api/departs/${selectedDepartId}/remises-passagers`)
        ).done(function(seatsRes, categoriesRes, remisesRes) {
          const seats = seatsRes[0];
          passagerCategories = categoriesRes[0] || [];
          remisesByCategorie = buildRemisesMap(remisesRes[0] || []);

          if (!seats || seats.length === 0) {
            showAlert('Aucune configuration de sièges ou tarifs pour ce départ', 'danger');
            return;
          }

          $('#step0').hide();
          $('#step2').show();
          renderSeats(seats);
        }).fail(function(xhr) {
          console.error('Erreur seat map:', xhr);
          const error = xhr.responseJSON ? xhr.responseJSON.message : 'Impossible de récupérer les sièges';
          showAlert(error, 'danger');
        });
      }).fail(function(xhr) {
        console.error('Erreur chargement départ:', xhr);
        showAlert('Impossible de charger les informations du départ', 'danger');
      });
    }

    function goBackFromStep2() {
      // Vérifier si on vient du calendrier (step0 existe)
      if ($('#step0').length && $('#clientIdSimple').val()) {
        $('#step2').hide();
        $('#step0').show();
      } else {
        goToStep1();
      }
    }

    function getStatusBadgeClass(code) {
      const classes = {
        'PROGRAMME': 'info',
        'EN_COURS': 'primary',
        'TERMINE': 'secondary',
        'ANNULE': 'danger',
        'COMPLET': 'success'
      };
      return classes[code] || 'secondary';
    }

    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <link href="img/logo/logo.png" rel="icon">
  <title>Taxi Brousse - Réservations</title>
  <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="css/ruang-admin.min.css" rel="stylesheet">
  <style>
    .calendar-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e3e6f0;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    .calendar-day-header {
      text-align: center;
      font-weight: bold;
      padding: 10px;
      background: #f8f9fc;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .calendar-day {
      min-height: 100px;
      border: 1px solid #e3e6f0;
      border-radius: 4px;
      padding: 8px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }
    .calendar-day:hover {
      background: #f8f9fc;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    .calendar-day.other-month {
      background: #fafbfc;
      color: #999;
    }
    .calendar-day.today {
      background: #e7f3ff;
      border-color: #4e73df;
    }
    .calendar-day.has-departs {
      background: #d1ecf1;
      border-color: #17a2b8;
    }
    .calendar-day.has-departs:hover {
      background: #bee5eb;
    }
    .day-number {
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 5px;
    }
    .departs-count {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #17a2b8;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: bold;
    }
    .depart-card {
      border-left: 4px solid #4e73df;
      margin-bottom: 15px;
      transition: all 0.3s;
      overflow: hidden;
    }
    .depart-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateX(5px);
    }
    .depart-card.en-cours {
      border-left-color: #858796;
      opacity: 0.7;
      cursor: not-allowed;
      background-color: #f8f9fc;
      pointer-events: none;
    }
    .depart-card.en-cours:hover {
      box-shadow: none;
      transform: none;
    }
    .depart-card .card-body {
      padding: 12px;
    }
    .places-indicator {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 15px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .places-disponibles {
      background: #d4edda;
      color: #155724;
    }
    .places-limitees {
      background: #fff3cd;
      color: #856404;
    }
    .places-completes {
      background: #f8d7da;
      color: #721c24;
    }
    .loading-spinner {
      display: none;
      text-align: center;
      padding: 40px;
    }
  </style>
</head>

<body id="page-top">
  <div id="wrapper">
    <!-- Sidebar -->
    <div th:replace="~{taxi_brousse/fragments :: sidebar}"></div>
    <ul class="navbar-nav sidebar sidebar-light accordion" id="accordionSidebar" style="display:none;">
      <a class="sidebar-brand d-flex align-items-center justify-content-center" href="/">
        <div class="sidebar-brand-icon">
          <img src="img/logo/logo2.png">
        </div>
        <div class="sidebar-brand-text mx-3">Taxi Brousse</div>
      </a>
      <hr class="sidebar-divider my-0">
      <li class="nav-item">
        <a class="nav-link" href="/">
          <i class="fas fa-fw fa-tachometer-alt"></i>
          <span>Dashboard</span></a>
      </li>
      <hr class="sidebar-divider">
      <div class="sidebar-heading">
        Gestion
      </div>
      <li class="nav-item">
        <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseGestion"
          aria-expanded="true" aria-controls="collapseGestion">
          <i class="fas fa-fw fa-car"></i>
          <span>Transport</span>
        </a>
        <div id="collapseGestion" class="collapse" aria-labelledby="headingGestion" data-parent="#accordionSidebar">
          <div class="bg-white py-2 collapse-inner rounded">
            <h6 class="collapse-header">Gestion Transport</h6>
            <a class="collapse-item" href="/cooperatives">Coopératives</a>
            <a class="collapse-item" href="/vehicules">Véhicules</a>
            <a class="collapse-item" href="/chauffeurs">Chauffeurs</a>
            <a class="collapse-item" href="/trajets">Trajets</a>
            <a class="collapse-item" href="/lieux">Lieux</a>
          </div>
        </div>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/tarifs">
          <i class="fas fa-fw fa-dollar-sign"></i>
          <span>Tarifs</span>
        </a>
      </li>
      <li class="nav-item active">
        <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseReservation" aria-expanded="true"
          aria-controls="collapseReservation">
          <i class="fas fa-fw fa-ticket-alt"></i>
          <span>Réservations</span>
        </a>
        <div id="collapseReservation" class="collapse show" aria-labelledby="headingReservation" data-parent="#accordionSidebar">
          <div class="bg-white py-2 collapse-inner rounded">
            <h6 class="collapse-header">Réservations</h6>
            <a class="collapse-item" href="/clients">Clients</a>
            <a class="collapse-item active" href="/reservations">Départs Disponibles</a>
            <a class="collapse-item" href="/reservations-liste">Liste Réservations</a>
            <a class="collapse-item" href="/reservations-critere">Réservations avec critere</a>
            <a class="collapse-item" href="/departs">Départs</a>
            <a class="collapse-item" href="/billets">Billets</a>
          </div>
        </div>
      </li>
      <hr class="sidebar-divider">
      <div class="version" id="version-ruangadmin"></div>
    </ul>
    <!-- Sidebar -->
    <div id="content-wrapper" class="d-flex flex-column">
      <div id="content">
        <!-- TopBar -->
        <nav class="navbar navbar-expand navbar-light bg-navbar topbar mb-4 static-top">
          <button id="sidebarToggleTop" class="btn btn-link rounded-circle mr-3">
            <i class="fa fa-bars"></i>
          </button>
          <ul class="navbar-nav ml-auto">
            <div class="topbar-divider d-none d-sm-block"></div>
            <li class="nav-item dropdown no-arrow">
              <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false">
                <img class="img-profile rounded-circle" src="img/boy.png" style="max-width: 60px">
                <span class="ml-2 d-none d-lg-inline text-white small">Admin</span>
              </a>
              <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in" aria-labelledby="userDropdown">
                <a class="dropdown-item" href="#">
                  <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>
                  Profile
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="javascript:void(0);" data-toggle="modal" data-target="#logoutModal">
                  <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                  Logout
                </a>
              </div>
            </li>
          </ul>
        </nav>
        <!-- Topbar -->
        <!-- Container Fluid-->
        <div class="container-fluid" id="container-wrapper">
          <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h3 mb-0 text-gray-800">
              <i class="fas fa-calendar-alt"></i> Départs Disponibles
            </h1>
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="/">Home</a></li>
              <li class="breadcrumb-item">Réservations</li>
              <li class="breadcrumb-item active" aria-current="page">Réservations</li>
            </ol>
          </div>

          <div class="row">
            <div class="col-lg-8">
              <div class="calendar-container">
                <div class="calendar-header">
                  <button id="prevMonth" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-chevron-left"></i> Précédent
                  </button>
                  <h4 id="currentMonth" class="mb-0"></h4>
                  <button id="nextMonth" class="btn btn-sm btn-outline-primary">
                    Suivant <i class="fas fa-chevron-right"></i>
                  </button>
                </div>
                <div class="calendar-grid">
                  <div class="calendar-day-header">Lun</div>
                  <div class="calendar-day-header">Mar</div>
                  <div class="calendar-day-header">Mer</div>
                  <div class="calendar-day-header">Jeu</div>
                  <div class="calendar-day-header">Ven</div>
                  <div class="calendar-day-header">Sam</div>
                  <div class="calendar-day-header">Dim</div>
                </div>
                <div id="calendarDays" class="calendar-grid mt-2"></div>
              </div>
            </div>

            <div class="col-lg-4">
              <div class="card">
                <div class="card-header py-3 bg-primary text-white">
                  <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-bus"></i> Départs du <span id="selectedDate"></span>
                  </h6>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                  <div id="loading" class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                      <span class="sr-only">Chargement...</span>
                    </div>
                  </div>
                  <div id="departsContainer">
                    <div class="text-center text-muted py-5">
                      <i class="fas fa-calendar-day fa-3x mb-3"></i>
                      <p>Sélectionnez une date dans le calendrier</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!--Row-->

          <!-- Modal Logout -->
          <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabelLogout"
            aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabelLogout">Confirmation</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <p>Voulez-vous vraiment vous déconnecter?</p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-outline-primary" data-dismiss="modal">Annuler</button>
                  <a href="/" class="btn btn-primary">Se déconnecter</a>
                </div>
              </div>
            </div>
          </div>

        </div>
        <!---Container Fluid-->
      </div>
      <!-- Footer -->
      <footer class="sticky-footer bg-white">
        <div class="container my-auto">
          <div class="copyright text-center my-auto">
            <span>copyright &copy; <script> document.write(new Date().getFullYear()); </script> - Gestion Taxi Brousse
            </span>
          </div>
        </div>
      </footer>
      <!-- Footer -->
    </div>
  </div>

  <!-- Scroll to top -->
  <a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
  </a>

  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="vendor/jquery-easing/jquery.easing.min.js"></script>
  <script src="js/ruang-admin.min.js"></script>

  <script>
    let currentDate = new Date();
    let departsCache = {};

    $(document).ready(function() {
      renderCalendar();
      loadDepartsForMonth();
    });

    $('#prevMonth').click(function() {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
      loadDepartsForMonth();
    });

    $('#nextMonth').click(function() {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
      loadDepartsForMonth();
    });

    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                        'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
      $('#currentMonth').text(monthNames[month] + ' ' + year);
      
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      
      let startDay = firstDay.getDay();
      startDay = startDay === 0 ? 6 : startDay - 1;
      
      $('#calendarDays').empty();
      
      const prevMonthDays = new Date(year, month, 0).getDate();
      for (let i = startDay - 1; i >= 0; i--) {
        const day = prevMonthDays - i;
        $('#calendarDays').append(createDayElement(day, true, null));
      }
      
      const today = new Date();
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const date = new Date(year, month, day);
        const isToday = date.toDateString() === today.toDateString();
        const dateStr = formatDate(date);
        $('#calendarDays').append(createDayElement(day, false, dateStr, isToday));
      }
      
      const totalCells = $('#calendarDays').children().length;
      const remainingCells = 42 - totalCells;
      for (let day = 1; day <= remainingCells; day++) {
        $('#calendarDays').append(createDayElement(day, true, null));
      }
    }

    function createDayElement(day, isOtherMonth, dateStr, isToday = false) {
      let classes = 'calendar-day';
      if (isOtherMonth) classes += ' other-month';
      if (isToday) classes += ' today';
      
      const hasDeparts = dateStr && departsCache[dateStr] && departsCache[dateStr].length > 0;
      if (hasDeparts) classes += ' has-departs';
      
      const countBadge = hasDeparts ? 
        `<div class="departs-count">${departsCache[dateStr].length}</div>` : '';
      
      const onclick = isOtherMonth ? '' : `onclick="selectDate('${dateStr}')"`;      
      return `
        <div class="${classes}" ${onclick} data-date="${dateStr}">
          <div class="day-number">${day}</div>
          ${countBadge}
        </div>
      `;
    }

    function loadDepartsForMonth() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      
      const dateDebut = formatDate(firstDay);
      const dateFin = formatDate(lastDay);
      
      $.ajax({
        url: `/api/departs/par-date?dateDebut=${dateDebut}&dateFin=${dateFin}`,
        method: 'GET',
        success: function(departs) {
          departsCache = {};
          departs.forEach(depart => {
            const date = depart.dateHeureDepart.split('T')[0];
            if (!departsCache[date]) {
              departsCache[date] = [];
            }
            departsCache[date].push(depart);
          });
          renderCalendar();
        },
        error: function(xhr) {
          console.error('Erreur lors du chargement des départs', xhr);
        }
      });
    }

    function selectDate(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      $('#selectedDate').text(date.toLocaleDateString('fr-FR', options));
      
      $('#loading').show();
      $('#departsContainer').hide();
      
      $.ajax({
        url: `/api/departs/par-jour?date=${dateStr}`,
        method: 'GET',
        success: function(departs) {
          $('#loading').hide();
          $('#departsContainer').show();
          
          if (departs.length === 0) {
            $('#departsContainer').html(`
              <div class="text-center text-muted py-5">
                <i class="fas fa-calendar-times fa-3x mb-3"></i>
                <p>Aucun départ disponible pour cette date</p>
              </div>
            `);
          } else {
            let html = '';
            departs.forEach(depart => {
              html += createDepartCard(depart);
            });
            $('#departsContainer').html(html);
          }
        },
        error: function(xhr) {
          $('#loading').hide();
          $('#departsContainer').show().html(`
            <div class="alert alert-danger">
              Erreur lors du chargement des départs
            </div>
          `);
        }
      });
    }

    function createDepartCard(depart) {
      const dateTime = new Date(depart.dateHeureDepart);
      const time = dateTime.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
      
      const placesOccupees = depart.placesOccupees || 0;
      const placesTotal = depart.nombrePlaces;
      const placesDisponibles = placesTotal - placesOccupees;
      const tauxOccupation = (placesOccupees / placesTotal) * 100;
      
      // Vérifier si le départ est en cours
      const isEnCours = depart.refDepartStatutCode === 'EN_COURS';
      const cardClass = isEnCours ? 'depart-card en-cours' : 'depart-card';
      const onclick = isEnCours ? '' : `onclick="reserverDepart(${depart.id})" style="cursor: pointer;"`;
      
      let placesClass = 'places-disponibles';
      let placesIcon = 'fa-check-circle';
      if (tauxOccupation >= 80) {
        placesClass = 'places-limitees';
        placesIcon = 'fa-exclamation-circle';
      }
      if (placesDisponibles === 0) {
        placesClass = 'places-completes';
        placesIcon = 'fa-times-circle';
      }
      
      let messageEnCours = '';
      if (isEnCours) {
        messageEnCours = `
          <div class="alert alert-warning mb-2 py-2">
            <i class="fas fa-info-circle"></i>
            <small><strong>Départ déjà en cours</strong> - Réservation non disponible</small>
          </div>
        `;
      }
      
      return `
        <div class="card ${cardClass} mb-3" ${onclick}>
          <div class="card-body">
            ${messageEnCours}
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="flex-grow-1">
                <h6 class="mb-1">
                  <i class="fas fa-clock text-primary"></i> ${time}
                  <span class="badge badge-info ml-2">${depart.code}</span>
                </h6>
                <p class="mb-1 text-muted small">
                  <i class="fas fa-building"></i> ${depart.cooperativeNom}
                </p>
              </div>
              <span class="badge badge-${getStatusBadgeClass(depart.refDepartStatutCode)} ml-2">
                ${depart.refDepartStatutLibelle}
              </span>
            </div>
            
            <div class="mb-2">
              <small>
                <i class="fas fa-map-marker-alt text-success"></i>
                <strong>${depart.lieuDepartNom}</strong>
                <i class="fas fa-arrow-right mx-2 text-muted"></i>
                <i class="fas fa-map-marker-alt text-danger"></i>
                <strong>${depart.lieuArriveeNom}</strong>
              </small>
            </div>
            
            <div class="d-flex justify-content-between align-items-center flex-wrap">
              <small class="text-muted mb-1">
                <i class="fas fa-car"></i> ${depart.vehiculeImmatriculation}
              </small>
              <span class="places-indicator ${placesClass} mb-1">
                <i class="fas ${placesIcon} mr-1"></i>
                ${placesDisponibles} / ${placesTotal} places
              </span>
            </div>
          </div>
        </div>
      `;
    }

    function reserverDepart(departId) {
      window.location.href = `/reservations-new?departId=${departId}`;
    }

    function getStatusBadgeClass(code) {
      const classes = {
        'PROGRAMME': 'info',
        'EN_COURS': 'primary',
        'TERMINE': 'secondary',
        'ANNULE': 'danger',
        'COMPLET': 'success'
      };
      return classes[code] || 'secondary';
    }

    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
  </script>

</body>

</html>

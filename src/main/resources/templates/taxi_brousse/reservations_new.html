<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">

<head>
    <div th:replace="~{taxi_brousse/fragments :: sidebar}"></div>
    <!-- Sidebar -->
    .seat-btn.occupied.seat-cat-premium,
    .seat-btn.occupied.seat-cat-standard {
      background: #f44336;
      color: #fff;
    }
    .badge.seat-cat-vip {
      background: #fff8e1;
      color: #8a6d1f;
      border: 1px solid #d4af37;
    }
    .badge.seat-cat-premium {
      background: #f3e5f5;
      color: #5e2a7a;
      border: 1px solid #8e44ad;
    }
    .badge.seat-cat-standard {
      background: #e3f2fd;
      color: #1b4f72;
      border: 1px solid #3498db;
    }
    .depart-card {
      border-left: 4px solid #6777ef;
      cursor: pointer;
      transition: all 0.3s;
    }
    .depart-card:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    .badge-places {
      font-size: 0.9rem;
    }
  </style>
</head>

<body id="page-top">
  <div id="wrapper">
    <!-- Sidebar -->
    <ul class="navbar-nav sidebar sidebar-light accordion" id="accordionSidebar">
      <a class="sidebar-brand d-flex align-items-center justify-content-center" href="/index">
        <div class="sidebar-brand-icon">
          <img src="/img/logo/logo2.png">
        </div>
        <div class="sidebar-brand-text mx-3">Taxi Brousse</div>
      </a>
      <hr class="sidebar-divider my-0">
      <li class="nav-item">
        <a class="nav-link" href="/index">
          <i class="fas fa-fw fa-tachometer-alt"></i>
          <span>Dashboard</span></a>
      </li>
      <hr class="sidebar-divider">
      <div class="sidebar-heading">Gestion</div>
      <li class="nav-item">
        <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseGestion"
          aria-expanded="true" aria-controls="collapseGestion">
          <i class="fas fa-fw fa-car"></i>
          <span>Transport</span>
        </a>
        <div id="collapseGestion" class="collapse" aria-labelledby="headingGestion" data-parent="#accordionSidebar">
          <div class="bg-white py-2 collapse-inner rounded">
            <h6 class="collapse-header">Gestion Transport</h6>
            <a class="collapse-item" href="/cooperatives">Coopératives</a>
            <a class="collapse-item" href="/vehicules">Véhicules</a>
            <a class="collapse-item" href="/chauffeurs">Chauffeurs</a>
            <a class="collapse-item" href="/trajets">Trajets</a>
            <a class="collapse-item" href="/lieux">Lieux</a>
          </div>
        </div>
      </li>
      <li class="nav-item active">
        <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseReservation"
          aria-expanded="true" aria-controls="collapseReservation">
          <i class="fas fa-fw fa-ticket-alt"></i>
          <span>Réservations</span>
        </a>
        <div id="collapseReservation" class="collapse show" aria-labelledby="headingReservation"
          data-parent="#accordionSidebar">
          <div class="bg-white py-2 collapse-inner rounded">
            <h6 class="collapse-header">Réservations</h6>
            <a class="collapse-item" href="/clients">Clients</a>
            <a class="collapse-item active" href="/reservations">Réservations</a>
            <a class="collapse-item" href="/reservations-critere">Réservations avec critere</a>
            <a class="collapse-item" href="/departs">Départs</a>            <a class="collapse-item" href="/billets">Billets</a>          </div>
        </div>
      </li>
    </ul>
    <!-- End Sidebar -->

    <div id="content-wrapper" class="d-flex flex-column">
      <div id="content">
        <!-- TopBar -->
        <nav class="navbar navbar-expand navbar-light bg-navbar topbar mb-4 static-top">
          <button id="sidebarToggleTop" class="btn btn-link rounded-circle mr-3">
            <i class="fa fa-bars"></i>
          </button>
          <ul class="navbar-nav ml-auto">
            <li class="nav-item dropdown no-arrow">
              <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown">
                <img class="img-profile rounded-circle" src="img/boy.png" style="max-width: 60px">
                <span class="ml-2 d-none d-lg-inline text-white small">Administrateur</span>
              </a>
            </li>
          </ul>
        </nav>
        <!-- End TopBar -->

        <!-- Container Fluid-->
        <div class="container-fluid" id="container-wrapper">
          <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h3 mb-0 text-gray-800">Réservations <span class="badge badge-success">Liste Départs</span></h1>
            <button class="btn btn-primary" data-toggle="modal" data-target="#nouvelleReservationModal">
              <i class="fas fa-plus"></i> Nouvelle Réservation
            </button>
          </div>

          <!-- Alert Messages -->
          <div id="alertContainer"></div>

          <!-- Departs Disponibles -->
          <div class="row">
            <div class="col-lg-12">
              <div class="card mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                  <h6 class="m-0 font-weight-bold text-primary">Départs Disponibles</h6>
                </div>
                <div class="card-body">
                  <div class="row" id="departsContainer">
                    <!-- Departs will be loaded here -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Table Reservations -->
          <div class="row">
            <div class="col-lg-12">
              <div class="card mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                  <h6 class="m-0 font-weight-bold text-primary">Liste des Réservations</h6>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table align-items-center table-flush table-hover" id="reservationsTable">
                      <thead class="thead-light">
                        <tr>
                          <th>Code</th>
                          <th>Client</th>
                          <th>Départ</th>
                          <th>Trajet</th>
                          <th>Date Départ</th>
                          <th>Passagers</th>
                          <th>Statut</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody id="reservationsTableBody">
                        <!-- Data will be loaded here -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
        <!-- End Container Fluid -->
      </div>
      <!-- Footer -->
      <footer class="sticky-footer bg-white">
        <div class="container my-auto">
          <div class="copyright text-center my-auto">
            <span>&copy; 2026 Gestion Taxi Brousse</span>
          </div>
        </div>
      </footer>
    </div>
  </div>

  <!-- Modal Nouvelle Réservation -->
  <div class="modal fade" id="nouvelleReservationModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Nouvelle Réservation</h5>
          <button type="button" class="close" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="reservationForm">
            <!-- Step 1: Client et Départ -->
            <div id="step1">
              <h6 class="mb-3">Informations Générales</h6>
              <div class="form-group">
                <label>Client *</label>
                <select class="form-control" id="clientId" required>
                  <option value="">Sélectionnez un client</option>
                </select>
              </div>
              <div class="form-group">
                <label>Départ *</label>
                <select class="form-control" id="departId" required>
                  <option value="">Sélectionnez un départ</option>
                </select>
              </div>
              <div class="form-group">
                <label>Notes</label>
                <textarea class="form-control" id="notes" rows="2"></textarea>
              </div>
              <button type="button" class="btn btn-primary" onclick="goToStep2()">Suivant : Sélection des places</button>
            </div>

            <!-- Step 2: Selection des places -->
            <div id="step2" style="display:none;">
              <h6 class="mb-3">Sélection des Places</h6>
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Cliquez sur les sièges disponibles pour sélectionner les places.
              </div>
              <div id="seatInfo" class="mb-3">
                <span class="badge badge-success mr-2">
                  <i class="fas fa-circle"></i> Disponible
                </span>
                <span class="badge badge-danger mr-2">
                  <i class="fas fa-circle"></i> Occupé
                </span>
                <span class="badge badge-primary mr-2">
                  <i class="fas fa-circle"></i> Sélectionné
                </span>
              </div>
              <div id="seatsGrid" class="seat-grid"></div>
              
              <div id="passagersInfo" class="mt-4" style="display:none;">
                <div id="groupedSelectionSummary" class="mt-3"></div>
                <div id="groupSelectionPanel" class="mt-3"></div>
              </div>

              <div class="mt-3">
                <button type="button" class="btn btn-secondary" onclick="goToStep1()">Retour</button>
                <button type="button" class="btn btn-primary" id="nextToPayment" style="display:none;" onclick="goToStep3()">
                  Suivant : Paiement
                </button>
              </div>
            </div>

            <!-- Step 3: Paiement -->
            <div id="step3" style="display:none;">
              <h6 class="mb-3">Récapitulatif et Paiement</h6>
              
              <div class="alert alert-success">
                <h5>Montant total: <span id="montantTotalDisplay"></span></h5>
                <p class="mb-0"><strong>Nombre de passagers:</strong> <span id="nbPassagersDisplay"></span></p>
              </div>

              <div class="card mb-3">
                <div class="card-body">
                  <h6 class="mb-3">Tarifs par siège</h6>
                  <div class="table-responsive">
                    <table class="table table-sm table-hover">
                      <thead class="thead-light">
                        <tr>
                          <th>Siège</th>
                          <th>Catégorie siège</th>
                          <th>Catégorie passager</th>
                          <th>Tarif de base</th>
                          <th>Remise</th>
                          <th>Tarif à payer</th>
                        </tr>
                      </thead>
                      <tbody id="recapTarifsSiegesBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
              
              <div class="form-group">
                <label>Mode de paiement *</label>
                <select class="form-control" id="modePaiement" onchange="updatePaiementFields()" required>
                  <option value="">Sélectionnez un mode</option>
                  <option value="PAIEMENT_IMMEDIAT">Paiement immédiat</option>
                  <option value="COMPTOIR">Paiement au comptoir</option>
                  <option value="EMBARQUEMENT">Paiement à l'embarquement</option>
                </select>
              </div>
              
              <!-- Champs pour paiement immédiat -->
              <div id="paiementImmediatFields" style="display:none;">
                <div class="alert alert-info">
                  <i class="fas fa-info-circle"></i> Sélectionnez votre méthode de paiement
                </div>
                
                <div class="form-group">
                  <label>Méthode de paiement *</label>
                  <select class="form-control" id="methodePaiement" onchange="updateMethodeFields()">
                    <option value="">Sélectionnez une méthode</option>
                    <option value="ESPECES">Espèces</option>
                    <option value="MOBILE_MONEY">Mobile Money (MVola, Orange Money)</option>
                    <option value="CARTE_BANCAIRE">Carte bancaire</option>
                    <option value="CHEQUE">Chèque</option>
                  </select>
                </div>
                
                <!-- Champs Mobile Money -->
                <div id="mobileMoneyFields" style="display:none;">
                  <div class="form-group">
                    <label>Numéro de téléphone</label>
                    <input type="text" class="form-control" id="numeroTelephone" placeholder="Ex: 034 12 345 67">
                  </div>
                  <div class="form-group">
                    <label>Référence transaction</label>
                    <input type="text" class="form-control" id="referenceTransaction" placeholder="Code de transaction">
                  </div>
                </div>
                
                <!-- Champs Carte bancaire -->
                <div id="carteFields" style="display:none;">
                  <div class="form-group">
                    <label>Référence transaction</label>
                    <input type="text" class="form-control" id="refTransactionCarte" placeholder="Numéro d'autorisation">
                  </div>
                </div>
              </div>
              
              <!-- Info paiement différé -->
              <div id="paiementDiffereInfo" style="display:none;">
                <div class="alert alert-warning">
                  <i class="fas fa-exclamation-triangle"></i> 
                  <strong>Paiement différé</strong>
                  <p class="mb-0">Votre réservation sera créée avec le statut "En attente de paiement". 
                  Vous devrez effectuer le paiement <span id="lieuPaiement"></span>.</p>
                </div>
              </div>

              <div class="mt-3">
                <button type="button" class="btn btn-secondary" onclick="goBackToStep2()">Retour</button>
                <button type="submit" class="btn btn-success" id="submitReservation">
                  <i class="fas fa-check"></i> Confirmer la Réservation
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Details Réservation -->
  <div class="modal fade" id="detailsReservationModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Détails de la Réservation</h5>
          <button type="button" class="close" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body" id="detailsContent">
          <!-- Details will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
          <button type="button" class="btn btn-danger" id="annulerBtn" onclick="annulerReservation()">
            <i class="fas fa-times"></i> Annuler la Réservation
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- <script src="js/ruang-admin.min.js"></script> -->

  <script>
    let selectedSeats = [];
    let currentReservationId = null;
    let seatInfoByNumber = {};
    let passagerCategories = [];
    let remisesByCategorie = {};
    let clientsById = {};

    // Load page data
    $(document).ready(function() {
      loadClients();
      loadDepartsDisponibles();
      loadReservations();
      
      // Sidebar toggle
      $('#sidebarToggleTop').on('click', function() {
        $('body').toggleClass('sidebar-toggled');
        $('.sidebar').toggleClass('toggled');
      });
    });

    function loadClients() {
      $.get('/api/clients', function(clients) {
        const select = $('#clientId');
        clients.forEach(client => {
          clientsById[client.id] = client;
          select.append(`<option value="${client.id}">${client.nom} ${client.prenom || ''}</option>`);
        });
      });
    }

    function getSelectedClient() {
      const clientId = parseInt($('#clientId').val(), 10);
      return clientsById[clientId];
    }

    function loadDepartsDisponibles() {
      $.get('/api/departs/disponibles', function(departs) {
        const container = $('#departsContainer');
        const selectDepart = $('#departId');
        container.empty();
        selectDepart.find('option:not(:first)').remove();

        if (departs.length === 0) {
          container.html('<div class="col-12"><p class="text-muted">Aucun départ disponible</p></div>');
          return;
        }

        departs.forEach(depart => {
          const dateDepart = new Date(depart.dateHeureDepart).toLocaleString('fr-FR');
          const placesRestantes = depart.placesDisponibles || 0;
          const badgeColor = placesRestantes > 5 ? 'success' : placesRestantes > 0 ? 'warning' : 'danger';

          container.append(`
            <div class="col-md-6 mb-3">
              <div class="card depart-card">
                <div class="card-body">
                  <h6 class="font-weight-bold">${depart.trajetLibelle}</h6>
                  <p class="mb-1"><i class="fas fa-calendar"></i> ${dateDepart}</p>
                  <p class="mb-1"><i class="fas fa-building"></i> ${depart.cooperativeNom}</p>
                  <p class="mb-1"><i class="fas fa-car"></i> ${depart.vehiculeImmatriculation}</p>
                  <span class="badge badge-${badgeColor} badge-places">
                    ${placesRestantes} places disponibles / ${depart.nombrePlaces}
                  </span>
                </div>
              </div>
            </div>
          `);

          selectDepart.append(`<option value="${depart.id}">${depart.code} - ${depart.trajetLibelle} - ${dateDepart}</option>`);
        });
      });
    }

    function loadReservations() {
      $.get('/api/reservations', function(reservations) {
        const tbody = $('#reservationsTableBody');
        tbody.empty();

        reservations.forEach(res => {
          const dateDepart = new Date(res.dateHeureDepart).toLocaleString('fr-FR');
          const nbPassagers = res.passagers ? res.passagers.length : 0;
          const sieges = res.passagers ? res.passagers.map(p => p.numeroSiege).join(', ') : '';
          
          let statutBadge = 'secondary';
          if (res.refReservationStatutLibelle === 'Confirmé' || res.refReservationStatutLibelle === 'CONFIRME') statutBadge = 'success';
          else if (res.refReservationStatutLibelle === 'Annulé' || res.refReservationStatutLibelle === 'ANNULE') statutBadge = 'danger';
          else if (res.refReservationStatutLibelle === 'En attente') statutBadge = 'warning';

          tbody.append(`
            <tr>
              <td>${res.code}</td>
              <td>${res.clientNom} ${res.clientPrenom || ''}</td>
              <td>${res.departCode}</td>
              <td>${res.trajetLibelle}</td>
              <td>${dateDepart}</td>
              <td><span class="badge badge-info">${nbPassagers} passager(s)</span><br><small>Sièges: ${sieges}</small></td>
              <td><span class="badge badge-${statutBadge}">${res.refReservationStatutLibelle}</span></td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="viewDetails(${res.id})">
                  <i class="fas fa-eye"></i>
                </button>
              </td>
            </tr>
          `);
        });
      });
    }

    function goToStep2() {
      const departId = $('#departId').val();
      if (!departId) {
        showAlert('Veuillez sélectionner un départ', 'warning');
        return;
      }

      $.when(
        $.get(`/api/departs/${departId}/seat-map`),
        $.get('/api/reference/passager-categories'),
        $.get(`/api/departs/${departId}/remises-passagers`)
      ).done(function(seatsRes, categoriesRes, remisesRes) {
        const seats = seatsRes[0];
        passagerCategories = categoriesRes[0] || [];
        remisesByCategorie = buildRemisesMap(remisesRes[0] || []);

        if (!seats || seats.length === 0) {
          showAlert('Aucune configuration de sièges ou tarifs pour ce départ', 'danger');
          return;
        }

        $('#step1').hide();
        $('#step2').show();
        renderSeats(seats);
      }).fail(function(xhr) {
        console.error('Erreur seat map:', xhr);
        const error = xhr.responseJSON ? xhr.responseJSON.message : 'Impossible de récupérer les sièges';
        showAlert(error, 'danger');
      });
    }

    function goToStep1() {
      $('#step2').hide();
      $('#step1').show();
      selectedSeats = [];
    }

    function renderSeats(seats) {
      const grid = $('#seatsGrid');
      grid.empty();
      selectedSeats = [];
      seatInfoByNumber = {};

      const sortedSeats = seats.sort((a, b) => a.numeroSiege - b.numeroSiege);
      renderSeatLegend(sortedSeats);

      sortedSeats.forEach(seat => {
        seatInfoByNumber[seat.numeroSiege] = seat;
        const isAvailable = seat.disponible;
        const categoryClass = getCategoryClass(seat.refSiegeCategorieCode);
        const className = isAvailable ? `seat-btn ${categoryClass}` : `seat-btn ${categoryClass} occupied`;
        const disabled = !isAvailable ? 'disabled' : '';
        const priceLabel = seat.montant ? formatMoney(seat.montant, seat.deviseCode) : '';

        const btn = $(`
          <button type="button" class="${className}" ${disabled} data-seat="${seat.numeroSiege}" data-category="${seat.refSiegeCategorieCode}">
            <i class="fas fa-chair"></i><br>Siège ${seat.numeroSiege}
            <div><small>${seat.refSiegeCategorieLibelle || ''}</small></div>
            <div><small>${priceLabel}</small></div>
          </button>
        `);

        if (isAvailable) {
          btn.on('click', function() {
            toggleSeat(seat.numeroSiege, $(this));
          });
        }

        grid.append(btn);
      });
    }

    function getCategoryClass(code) {
      if (!code) return '';
      return `seat-cat-${code.toLowerCase()}`;
    }

    function formatMoney(amount, deviseCode) {
      const num = Number(amount || 0);
      return num.toLocaleString('fr-FR', { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + ' ' + (deviseCode || '');
    }

    function renderSeatLegend(seats) {
      const legend = $('#seatInfo');
      const categories = {};
      seats.forEach(seat => {
        if (!categories[seat.refSiegeCategorieCode]) {
          categories[seat.refSiegeCategorieCode] = seat;
        }
      });

      let html = `
        <span class="badge badge-success mr-2">
          <i class="fas fa-circle"></i> Disponible
        </span>
        <span class="badge badge-danger mr-2">
          <i class="fas fa-circle"></i> Occupé
        </span>
        <span class="badge badge-primary mr-2">
          <i class="fas fa-circle"></i> Sélectionné
        </span>
      `;

      Object.values(categories).forEach(cat => {
        const className = getCategoryClass(cat.refSiegeCategorieCode);
        const priceLabel = cat.montant ? formatMoney(cat.montant, cat.deviseCode) : '';
        html += `
          <span class="badge badge-light mr-2 ${className}">
            ${cat.refSiegeCategorieLibelle || cat.refSiegeCategorieCode} - ${priceLabel}
          </span>
        `;
      });

      legend.html(html);
    }

    function toggleSeat(seatNumber, btn) {
      const index = selectedSeats.indexOf(seatNumber);

      if (index > -1) {
        selectedSeats.splice(index, 1);
        btn.removeClass('selected');
      } else {
        selectedSeats.push(seatNumber);
        btn.addClass('selected');
      }

      if (selectedSeats.length > 0) {
        showPassagersForms();
      } else {
        $('#passagersInfo').hide();
        $('#nextToPayment').hide();
      }
    }

    function showPassagersForms() {
      renderGroupedSelection();
      renderGroupSelectionPanel();
      updateSeatCategoryLabels();

      $('#passagersInfo').show();
      $('#nextToPayment').show();
    }

    function ensureHiddenCategoryInputs() {
      const container = $('#groupSelectionPanel');
      if (container.find('.passager-categorie').length > 0) {
        return;
      }
      const categoriesOptions = passagerCategories.map(c => `<option value="${c.id}">${c.libelle}</option>`).join('');
      const hidden = selectedSeats.map(seat => {
        return `
          <select class="form-control passager-categorie d-none" data-seat="${seat}" required>
            <option value="">Sélectionner</option>
            ${categoriesOptions}
          </select>
          <span class="passager-categorie-label d-none" data-seat="${seat}"></span>
        `;
      }).join('');
      container.append(`<div class="d-none" id="hiddenPassagerCategories">${hidden}</div>`);
    }

    function getSeatCategoryGroups() {
      const groups = {};
      selectedSeats.forEach(seat => {
        const info = seatInfoByNumber[seat] || {};
        const catId = info.refSiegeCategorieId;
        if (!catId) {
          return;
        }
        if (!groups[catId]) {
          groups[catId] = {
            catId,
            label: info.refSiegeCategorieLibelle || info.refSiegeCategorieCode || 'Catégorie',
            seats: []
          };
        }
        groups[catId].seats.push(seat);
      });
      return Object.values(groups).sort((a, b) => a.label.localeCompare(b.label));
    }

    function renderGroupSelectionPanel() {
      const panel = $('#groupSelectionPanel');
      const seatGroups = getSeatCategoryGroups();

      if (seatGroups.length === 0 || passagerCategories.length === 0) {
        panel.html('');
        return;
      }

      const headerCols = passagerCategories.map(c => `<th class="text-center">${c.libelle}</th>`).join('');
      const rows = seatGroups.map(g => {
        const inputs = passagerCategories.map(c => {
          return `
            <td class="text-center">
              <input type="number" min="0" class="form-control form-control-sm group-qty"
                data-seatcat-id="${g.catId}" data-passcat-id="${c.id}" value="0">
            </td>
          `;
        }).join('');

        return `
          <tr data-seatcat-id="${g.catId}" data-max="${g.seats.length}">
            <td><strong>${g.label}</strong></td>
            <td class="text-center">${g.seats.length}</td>
            ${inputs}
          </tr>
        `;
      }).join('');

      panel.html(`
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Groupage par catégories</h6>
              <button type="button" class="btn btn-sm btn-outline-primary" id="groupApplyBtn" onclick="applyGroupedSelection()">
                Appliquer le groupage
              </button>
            </div>
            <div class="table-responsive">
              <table class="table table-sm table-bordered mb-0">
                <thead class="thead-light">
                  <tr>
                    <th>Catégorie siège</th>
                    <th class="text-center">Places</th>
                    ${headerCols}
                  </tr>
                </thead>
                <tbody>
                  ${rows}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `);
      ensureHiddenCategoryInputs();
      bindGroupQuantityValidation();
    }

    function bindGroupQuantityValidation() {
      const panel = $('#groupSelectionPanel');
      panel.off('input', '.group-qty');
      panel.on('input', '.group-qty', function() {
        const row = $(this).closest('tr');
        const max = parseInt(row.data('max'), 10) || 0;
        let sum = 0;
        row.find('.group-qty').each(function() {
          sum += parseInt($(this).val(), 10) || 0;
        });
        if (sum > max) {
          row.addClass('table-danger');
        } else {
          row.removeClass('table-danger');
        }
        const hasError = panel.find('tr.table-danger').length > 0;
        $('#groupApplyBtn').prop('disabled', hasError);
      });
    }

    function applyGroupedSelection() {
      const seatGroups = getSeatCategoryGroups();

      for (const group of seatGroups) {
        const inputs = $(`.group-qty[data-seatcat-id="${group.catId}"]`);
        let totalQty = 0;
        const assignments = [];

        inputs.each(function() {
          const qty = parseInt($(this).val(), 10) || 0;
          const passCatId = parseInt($(this).data('passcat-id'), 10);
          totalQty += qty;
          if (qty > 0) {
            assignments.push({ passCatId, qty });
          }
        });

        if (totalQty !== group.seats.length) {
          showAlert(`Le total pour ${group.label} doit être ${group.seats.length} place(s).`, 'warning');
          return;
        }

        let seatIndex = 0;
        assignments.forEach(a => {
          for (let i = 0; i < a.qty; i += 1) {
            const seat = group.seats[seatIndex];
            $(`.passager-categorie[data-seat="${seat}"]`).val(String(a.passCatId));
            seatIndex += 1;
          }
        });
      }

      renderGroupedSelection();
      updateSeatCategoryLabels();
    }

    function updateSeatCategoryLabels() {
      selectedSeats.forEach(seat => {
        const passagerCategorieId = parseInt($(`.passager-categorie[data-seat="${seat}"]`).val(), 10);
        const passagerCategorie = passagerCategories.find(c => String(c.id) === String(passagerCategorieId));
        const label = passagerCategorie ? passagerCategorie.libelle : 'Non défini';
        $(`.passager-categorie-label[data-seat="${seat}"]`).text(label);
      });
    }

    function renderGroupedSelection() {
      const summary = $('#groupedSelectionSummary');
      const groups = {};

      selectedSeats.forEach(seat => {
        const info = seatInfoByNumber[seat] || {};
        const catSiegeLabel = info.refSiegeCategorieLibelle || info.refSiegeCategorieCode || 'Catégorie';
        const passagerCategorieId = parseInt($(`.passager-categorie[data-seat="${seat}"]`).val(), 10);
        const passagerCategorie = passagerCategories.find(c => String(c.id) === String(passagerCategorieId));
        const passagerLabel = passagerCategorie ? passagerCategorie.libelle : 'Non défini';
        const key = `${catSiegeLabel}__${passagerLabel}`;

        if (!groups[key]) {
          groups[key] = { catSiegeLabel, passagerLabel, count: 0 };
        }
        groups[key].count += 1;
      });

      const items = Object.values(groups).sort((a, b) => {
        const aKey = `${a.catSiegeLabel}-${a.passagerLabel}`;
        const bKey = `${b.catSiegeLabel}-${b.passagerLabel}`;
        return aKey.localeCompare(bKey);
      });

      if (items.length === 0) {
        summary.html('');
        return;
      }

      summary.html(`
        <div class="alert alert-light mb-0">
          <strong>Groupage par catégorie:</strong>
          <ul class="mb-0">
            ${items.map(i => `<li>${i.catSiegeLabel} / ${i.passagerLabel} : ${i.count} place(s)</li>`).join('')}
          </ul>
        </div>
      `);
    }

    function buildRemisesMap(remises) {
      const map = {};
      (remises || []).forEach(r => {
        if (!map[r.refSiegeCategorieId]) {
          map[r.refSiegeCategorieId] = {};
        }
        map[r.refSiegeCategorieId][r.refPassagerCategorieId] = r;
      });
      return map;
    }

    function computeDiscountedAmount(info, passagerCategorieId) {
      if (!info || !info.montant) {
        return 0;
      }
      const remisesParPassager = remisesByCategorie[info.refSiegeCategorieId] || {};
      const remise = remisesParPassager[passagerCategorieId];
      let montant = Number(info.montant) || 0;
      if (!remise) {
        return montant;
      }
      let finalMontant = Number(remise.montant) || 0;
      if ((remise.typeRemise || '').toUpperCase() === 'POURCENT') {
        finalMontant = montant - (montant * (finalMontant / 100));
      }
      return finalMontant < 0 ? 0 : finalMontant;
    }

    function computeMontantTotal() {
      return selectedSeats.reduce((sum, seat) => {
        const info = seatInfoByNumber[seat];
        const passagerCategorieId = parseInt($(`.passager-categorie[data-seat="${seat}"]`).val(), 10);
        return sum + computeDiscountedAmount(info, passagerCategorieId);
      }, 0);
    }

    function renderTarifsRecap() {
      const tbody = $('#recapTarifsSiegesBody');
      tbody.empty();

      selectedSeats.sort((a, b) => a - b).forEach(seat => {
        const info = seatInfoByNumber[seat] || {};
        const passagerCategorieId = parseInt($(`.passager-categorie[data-seat="${seat}"]`).val(), 10);
        const passagerCategorie = passagerCategories.find(c => String(c.id) === String(passagerCategorieId));

        const baseLabel = info.montant ? formatMoney(info.montant, info.deviseCode) : '-';
        const finalAmount = computeDiscountedAmount(info, passagerCategorieId);
        const finalLabel = formatMoney(finalAmount, info.deviseCode);

        let remiseLabel = 'Aucune';
        let badge = '';
        const remisesParPassager = remisesByCategorie[info.refSiegeCategorieId] || {};
        const remise = remisesParPassager[passagerCategorieId];
        if (remise) {
          if ((remise.typeRemise || '').toUpperCase() === 'POURCENT') {
            remiseLabel = `${remise.montant}%`;
          } else {
            remiseLabel = `${formatMoney(remise.montant, info.deviseCode)} (tarif fixé)`;
          }
          badge = ' <span class="badge badge-success">Remise appliquée</span>';
        }

        const siegeLabel = info.refSiegeCategorieLibelle || info.refSiegeCategorieCode || '';
        const passagerLabel = passagerCategorie ? passagerCategorie.libelle : '';

        tbody.append(`
          <tr>
            <td>${seat}</td>
            <td>${siegeLabel}</td>
            <td>${passagerLabel}</td>
            <td>${baseLabel}</td>
            <td>${remiseLabel}${badge}</td>
            <td><strong>${finalLabel}</strong></td>
          </tr>
        `);
      });
    }
    
    function goToStep3() {
      // Valider que toutes les catégories passager sont renseignées
      let valid = true;
      selectedSeats.forEach(seat => {
        const categorie = $(`.passager-categorie[data-seat="${seat}"]`).val();
        if (!categorie) {
          valid = false;
        }
      });
      
      if (!valid) {
        showAlert('Veuillez sélectionner la catégorie de tous les passagers', 'warning');
        return;
      }
      
      const montantTotal = computeMontantTotal();

      const firstSeat = seatInfoByNumber[selectedSeats[0]] || {};
      const deviseCode = firstSeat.deviseCode || '';

      $('#montantTotalDisplay').text(montantTotal.toLocaleString('fr-FR') + ' ' + deviseCode);
      $('#nbPassagersDisplay').text(selectedSeats.length);

      renderTarifsRecap();
      
      $('#step2').hide();
      $('#step3').show();
    }
    
    function goBackToStep2() {
      $('#step3').hide();
      $('#step2').show();
    }
    
    function updatePaiementFields() {
      const mode = $('#modePaiement').val();
      
      if (mode === 'PAIEMENT_IMMEDIAT') {
        $('#paiementImmediatFields').show();
        $('#paiementDiffereInfo').hide();
      } else if (mode === 'COMPTOIR') {
        $('#paiementImmediatFields').hide();
        $('#paiementDiffereInfo').show();
        $('#lieuPaiement').text('au comptoir avant le départ');
      } else if (mode === 'EMBARQUEMENT') {
        $('#paiementImmediatFields').hide();
        $('#paiementDiffereInfo').show();
        $('#lieuPaiement').text('lors de l\'embarquement');
      } else {
        $('#paiementImmediatFields').hide();
        $('#paiementDiffereInfo').hide();
      }
    }
    
    function updateMethodeFields() {
      const methode = $('#methodePaiement').val();
      $('#mobileMoneyFields').hide();
      $('#carteFields').hide();
      
      if (methode === 'MOBILE_MONEY') {
        $('#mobileMoneyFields').show();
      } else if (methode === 'CARTE_BANCAIRE') {
        $('#carteFields').show();
      }
    }

    $('#reservationForm').submit(function(e) {
      e.preventDefault();

      const passagers = [];
      let valid = true;

      const client = getSelectedClient();
      if (!client) {
        showAlert('Veuillez sélectionner un client', 'warning');
        return;
      }

      selectedSeats.forEach(seat => {
        const categorieId = parseInt($(`.passager-categorie[data-seat="${seat}"]`).val(), 10);

        if (!categorieId) {
          valid = false;
          showAlert('Veuillez sélectionner la catégorie de tous les passagers', 'warning');
          return false;
        }

        passagers.push({
          nom: client.nom,
          prenom: client.prenom || null,
          numeroSiege: seat,
          refPassagerCategorieId: categorieId
        });
      });

      if (!valid) return;
      
      const modePaiement = $('#modePaiement').val();
      if (!modePaiement) {
        showAlert('Veuillez sélectionner un mode de paiement', 'warning');
        return;
      }

      const data = {
        clientId: parseInt($('#clientId').val()),
        departId: parseInt($('#departId').val()),
        notes: $('#notes').val() || null,
        passagers: passagers,
        modePaiement: modePaiement
      };
      
      // Ajouter les infos de paiement si paiement immédiat
      if (modePaiement === 'PAIEMENT_IMMEDIAT') {
        const methode = $('#methodePaiement').val();
        if (!methode) {
          showAlert('Veuillez sélectionner une méthode de paiement', 'warning');
          return;
        }
        
        const montantTotal = computeMontantTotal();
        data.paiementInfo = {
          montant: montantTotal,
          modePaiement: methode,
          numeroTelephone: $('#numeroTelephone').val() || null,
          referenceTransaction: $('#referenceTransaction').val() || $('#refTransactionCarte').val() || null
        };
      }

      $.ajax({
        url: '/api/reservations',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
          const message = modePaiement === 'PAIEMENT_IMMEDIAT' 
            ? 'Réservation créée et payée avec succès!' 
            : 'Réservation créée avec succès! N\'oubliez pas d\'effectuer le paiement.';
          showAlert(message, 'success');
          $('#nouvelleReservationModal').modal('hide');
          $('#reservationForm')[0].reset();
          goToStep1();
          loadReservations();
          loadDepartsDisponibles();
        },
        error: function(xhr) {
          const error = xhr.responseJSON ? xhr.responseJSON.message : 'Erreur lors de la création';
          showAlert(error, 'danger');
        }
      });
    });

    function viewDetails(id) {
      $.get(`/api/reservations/${id}`, function(reservation) {
        currentReservationId = id;
        const dateDepart = new Date(reservation.dateHeureDepart).toLocaleString('fr-FR');
        const passagersList = reservation.passagers.map(p => 
          `<li>Siège ${p.numeroSiege}: ${p.nom} ${p.prenom || ''}</li>`
        ).join('');

        $('#detailsContent').html(`
          <p><strong>Code:</strong> ${reservation.code}</p>
          <p><strong>Client:</strong> ${reservation.clientNom} ${reservation.clientPrenom || ''}</p>
          <p><strong>Départ:</strong> ${reservation.departCode}</p>
          <p><strong>Trajet:</strong> ${reservation.trajetLibelle}</p>
          <p><strong>Date de départ:</strong> ${dateDepart}</p>
          <p><strong>Statut:</strong> <span class="badge badge-success">${reservation.refReservationStatutLibelle}</span></p>
          <p><strong>Passagers:</strong></p>
          <ul>${passagersList}</ul>
          ${reservation.notes ? `<p><strong>Notes:</strong> ${reservation.notes}</p>` : ''}
        `);

        $('#detailsReservationModal').modal('show');
      });
    }

    function annulerReservation() {
      if (!currentReservationId) return;

      if (confirm('Êtes-vous sûr de vouloir annuler cette réservation?')) {
        $.ajax({
          url: `/api/reservations/${currentReservationId}/annuler`,
          method: 'PUT',
          success: function() {
            showAlert('Réservation annulée avec succès!', 'success');
            $('#detailsReservationModal').modal('hide');
            loadReservations();
            loadDepartsDisponibles();
          },
          error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.message : 'Erreur lors de l\'annulation';
            showAlert(error, 'danger');
          }
        });
      }
    }

    function showAlert(message, type) {
      const alert = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
          </button>
        </div>
      `;
      $('#alertContainer').html(alert);
      setTimeout(() => $('#alertContainer').empty(), 5000);
    }
  </script>
</body>
</html>

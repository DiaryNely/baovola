<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Gestion Taxi Brousse - Tarifs Publicité</title>
  <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet">
  <link href="css/ruang-admin.min.css" rel="stylesheet">
  <style>
    .badge-actuel {
      background-color: #28a745;
      color: white;
      font-weight: bold;
    }
    .badge-historique {
      background-color: #6c757d;
      color: white;
    }
    .card-stats {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .stat-icon {
      font-size: 2.5rem;
      opacity: 0.8;
    }
  </style>
</head>

<body id="page-top">
  <div id="wrapper">
    <!-- Sidebar -->
    <div th:replace="~{taxi_brousse/fragments :: sidebar}"></div>
    
    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">
      <div id="content">
        <!-- TopBar -->
        <div th:replace="~{taxi_brousse/fragments :: topbar}"></div>
        
        <!-- Container Fluid -->
        <div class="container-fluid" id="container-wrapper">
          <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h3 mb-0 text-gray-800">
              <i class="fas fa-dollar-sign"></i> Gestion des Tarifs Publicité
            </h1>
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="/">Accueil</a></li>
              <li class="breadcrumb-item">Publicité</li>
              <li class="breadcrumb-item active">Tarifs</li>
            </ol>
          </div>

          <!-- Carte Tarif Actuel -->
          <div class="row mb-3">
            <div class="col-lg-12">
              <div class="card card-stats mb-3">
                <div class="card-body">
                  <div class="row align-items-center">
                    <div class="col">
                      <h5 class="card-title text-uppercase text-white mb-2">
                        <i class="fas fa-star"></i> Tarif Actuel
                      </h5>
                      <h2 class="mb-0 text-white font-weight-bold" id="tarifActuelMontant">
                        Chargement...
                      </h2>
                      <p class="mb-0 text-white-50 small" id="tarifActuelInfo"></p>
                    </div>
                    <div class="col-auto">
                      <i class="fas fa-money-bill-wave stat-icon text-white"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="row mb-3">
            <div class="col-lg-12">
              <button class="btn btn-primary" onclick="openTarifModal()">
                <i class="fas fa-plus"></i> Nouveau Tarif
              </button>
              <button class="btn btn-warning" onclick="cloturerTarifActuel()">
                <i class="fas fa-stop-circle"></i> Clôturer le Tarif Actuel
              </button>
              <button class="btn btn-info" onclick="loadTarifs()">
                <i class="fas fa-sync-alt"></i> Actualiser
              </button>
            </div>
          </div>

          <!-- Table des Tarifs -->
          <div class="row">
            <div class="col-lg-12">
              <div class="card mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                  <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-list"></i> Historique des Tarifs
                  </h6>
                </div>
                <div class="table-responsive p-3">
                  <table class="table align-items-center table-flush table-hover" id="tarifTable">
                    <thead class="thead-light">
                      <tr>
                        <th>ID</th>
                        <th>Montant</th>
                        <th>Devise</th>
                        <th>Date Début</th>
                        <th>Date Fin</th>
                        <th>Validité (jours)</th>
                        <th>Statut</th>
                        <th>Description</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="tarifTableBody">
                      <tr>
                        <td colspan="9" class="text-center">
                          <i class="fas fa-spinner fa-spin"></i> Chargement...
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

        </div>
        <!-- End Container Fluid -->
      </div>
      <!-- Footer -->
      <div th:replace="~{taxi_brousse/fragments :: footer}"></div>
    </div>
  </div>

  <!-- Modal Créer/Modifier Tarif -->
  <div class="modal fade" id="tarifModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="tarifModalTitle">
            <i class="fas fa-plus-circle"></i> Nouveau Tarif
          </h5>
          <button type="button" class="close" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="tarifForm" class="needs-validation" novalidate>
            <input type="hidden" id="tarifId">
            
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="refDeviseId">Devise <span class="text-danger">*</span></label>
                  <select class="form-control" id="refDeviseId" required>
                    <option value="">-- Sélectionnez une devise --</option>
                  </select>
                  <div class="invalid-feedback">La devise est obligatoire</div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="form-group">
                  <label for="montant">Montant <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="montant" 
                           step="0.01" min="0.01" required>
                    <div class="input-group-append">
                      <span class="input-group-text" id="deviseSymbole">Ar</span>
                    </div>
                  </div>
                  <div class="invalid-feedback">Le montant est obligatoire et doit être supérieur à 0</div>
                  <small class="form-text text-muted">Prix par diffusion</small>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="dateDebut">Date de Début <span class="text-danger">*</span></label>
                  <input type="date" class="form-control" id="dateDebut" required>
                  <div class="invalid-feedback">La date de début est obligatoire</div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="form-group">
                  <label for="dateFin">Date de Fin</label>
                  <input type="date" class="form-control" id="dateFin">
                  <small class="form-text text-muted">
                    Laisser vide pour un tarif sans fin (tarif actuel)
                  </small>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="description">Description</label>
              <textarea class="form-control" id="description" rows="3" 
                        maxlength="500"></textarea>
              <small class="form-text text-muted">
                <span id="descriptionCount">0</span>/500 caractères
              </small>
            </div>

            <div class="custom-control custom-checkbox">
              <input type="checkbox" class="custom-control-input" id="actif" checked>
              <label class="custom-control-label" for="actif">Tarif actif</label>
            </div>

            <div class="alert alert-info mt-3" role="alert">
              <i class="fas fa-info-circle"></i>
              <strong>Note importante :</strong> Un seul tarif peut être actuel (sans date de fin) à la fois.
              Si vous créez un nouveau tarif actuel, clôturez d'abord le tarif en cours.
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            <i class="fas fa-times"></i> Annuler
          </button>
          <button type="button" class="btn btn-primary" onclick="saveTarif()">
            <i class="fas fa-save"></i> Enregistrer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Visualisation -->
  <div class="modal fade" id="viewTarifModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            <i class="fas fa-eye"></i> Détails du Tarif #<span id="viewTarifId"></span>
          </h5>
          <button type="button" class="close text-white" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <h6 class="text-primary"><i class="fas fa-money-bill"></i> Informations Tarifaires</h6>
              <table class="table table-sm">
                <tr>
                  <td class="font-weight-bold">Montant :</td>
                  <td id="viewMontant"></td>
                </tr>
                <tr>
                  <td class="font-weight-bold">Devise :</td>
                  <td id="viewDevise"></td>
                </tr>
                <tr>
                  <td class="font-weight-bold">Statut :</td>
                  <td id="viewStatut"></td>
                </tr>
              </table>
            </div>
            <div class="col-md-6">
              <h6 class="text-primary"><i class="fas fa-calendar"></i> Période de Validité</h6>
              <table class="table table-sm">
                <tr>
                  <td class="font-weight-bold">Date Début :</td>
                  <td id="viewDateDebut"></td>
                </tr>
                <tr>
                  <td class="font-weight-bold">Date Fin :</td>
                  <td id="viewDateFin"></td>
                </tr>
                <tr>
                  <td class="font-weight-bold">Durée :</td>
                  <td id="viewDuree"></td>
                </tr>
              </table>
            </div>
          </div>
          
          <div class="row mt-3">
            <div class="col-12">
              <h6 class="text-primary"><i class="fas fa-info-circle"></i> Description</h6>
              <p id="viewDescription" class="text-muted"></p>
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-12">
              <h6 class="text-primary"><i class="fas fa-clock"></i> Informations Système</h6>
              <p class="text-muted small mb-0">
                <strong>Créé le :</strong> <span id="viewCreatedAt"></span>
              </p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            <i class="fas fa-times"></i> Fermer
          </button>
          <button type="button" class="btn btn-warning" onclick="editTarifFromView()">
            <i class="fas fa-edit"></i> Modifier
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Suppression -->
  <div class="modal fade" id="deleteTarifModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">
            <i class="fas fa-trash"></i> Confirmer la Suppression
          </h5>
          <button type="button" class="close text-white" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="deleteTarifId">
          <p>Êtes-vous sûr de vouloir supprimer ce tarif ?</p>
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Attention :</strong> Cette action est irréversible.
          </div>
          <p class="mb-0"><strong>Tarif :</strong> <span id="deleteTarifInfo"></span></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            <i class="fas fa-times"></i> Annuler
          </button>
          <button type="button" class="btn btn-danger" onclick="deleteTarif()">
            <i class="fas fa-trash"></i> Supprimer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="vendor/jquery-easing/jquery.easing.min.js"></script>
  <script src="vendor/datatables/jquery.dataTables.min.js"></script>
  <script src="vendor/datatables/dataTables.bootstrap4.min.js"></script>
  <script src="js/ruang-admin.min.js"></script>

  <script>
    let currentTarifId = null;

    $(document).ready(function() {
      loadDevises();
      loadTarifs();
      loadTarifActuel();
      
      // Compteur de caractères pour la description
      $('#description').on('input', function() {
        $('#descriptionCount').text($(this).val().length);
      });
      
      // Mettre à jour le symbole de devise
      $('#refDeviseId').on('change', function() {
        const selectedOption = $(this).find('option:selected');
        const symbole = selectedOption.data('symbole') || 'Ar';
        $('#deviseSymbole').text(symbole);
      });
    });

    // Charger les devises
    function loadDevises() {
      $.get('/api/reference/devises', function(data) {
        const select = $('#refDeviseId');
        select.empty().append('<option value="">-- Sélectionnez une devise --</option>');
        data.forEach(devise => {
          select.append(`<option value="${devise.id}" data-symbole="${devise.symbole || ''}">${devise.code} - ${devise.libelle}</option>`);
        });
      });
    }

    // Charger le tarif actuel
    function loadTarifActuel() {
      $.get('/api/tarifs-publicite/actuel')
        .done(function(tarif) {
          const symbole = tarif.refDeviseSymbole || tarif.refDeviseCode;
          $('#tarifActuelMontant').html(formatMontant(tarif.montant) + ' ' + symbole);
          $('#tarifActuelInfo').text(`En vigueur depuis le ${formatDate(tarif.dateDebut)}`);
        })
        .fail(function() {
          $('#tarifActuelMontant').html('<span class="text-white-50">Aucun tarif actuel</span>');
          $('#tarifActuelInfo').text('Veuillez créer un tarif');
        });
    }

    // Charger tous les tarifs
    function loadTarifs() {
      $.get('/api/tarifs-publicite', function(data) {
        const tbody = $('#tarifTableBody');
        tbody.empty();
        
        if (data.length === 0) {
          tbody.append('<tr><td colspan="9" class="text-center text-muted">Aucun tarif trouvé</td></tr>');
          return;
        }
        
        data.forEach(tarif => {
          const montant = formatMontant(tarif.montant);
          const devise = tarif.refDeviseCode || '';
          const dateDebut = formatDate(tarif.dateDebut);
          const dateFin = tarif.dateFin ? formatDate(tarif.dateFin) : '<span class="badge badge-actuel">Actuel</span>';
          const validite = tarif.nombreJoursValidite ? tarif.nombreJoursValidite + ' jours' : '∞';
          
          let statutBadge = '';
          if (tarif.estActuel) {
            statutBadge = '<span class="badge badge-success"><i class="fas fa-star"></i> Actuel</span>';
          } else if (tarif.estEnVigueur) {
            statutBadge = '<span class="badge badge-primary">En vigueur</span>';
          } else if (!tarif.actif) {
            statutBadge = '<span class="badge badge-secondary">Inactif</span>';
          } else {
            statutBadge = '<span class="badge badge-historique">Historique</span>';
          }
          
          const description = tarif.description 
            ? (tarif.description.length > 50 ? tarif.description.substring(0, 50) + '...' : tarif.description)
            : '<span class="text-muted">-</span>';
          
          const row = `
            <tr>
              <td>${tarif.id}</td>
              <td><strong>${montant} ${devise}</strong></td>
              <td>${tarif.refDeviseLibelle}</td>
              <td>${dateDebut}</td>
              <td>${dateFin}</td>
              <td>${validite}</td>
              <td>${statutBadge}</td>
              <td>${description}</td>
              <td>
                <button class="btn btn-sm btn-info" onclick="viewTarif(${tarif.id})" title="Voir">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-warning" onclick="editTarif(${tarif.id})" title="Modifier">
                  <i class="fas fa-edit"></i>
                </button>
                ${!tarif.estActuel ? `
                <button class="btn btn-sm btn-danger" onclick="confirmDeleteTarif(${tarif.id}, '${montant} ${devise}')" title="Supprimer">
                  <i class="fas fa-trash"></i>
                </button>
                ` : ''}
                ${tarif.actif ? `
                <button class="btn btn-sm btn-secondary" onclick="desactiverTarif(${tarif.id})" title="Désactiver">
                  <i class="fas fa-ban"></i>
                </button>
                ` : ''}
              </td>
            </tr>
          `;
          tbody.append(row);
        });
        
        // Initialiser DataTable
        if ($.fn.DataTable.isDataTable('#tarifTable')) {
          $('#tarifTable').DataTable().destroy();
        }
        $('#tarifTable').DataTable({
          "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/French.json"
          }
        });
      });
    }

    // Ouvrir modal création/modification
    function openTarifModal() {
      currentTarifId = null;
      $('#tarifForm')[0].reset();
      $('#tarifForm').removeClass('was-validated');
      $('#tarifId').val('');
      $('#tarifModalTitle').html('<i class="fas fa-plus-circle"></i> Nouveau Tarif');
      $('#actif').prop('checked', true);
      $('#descriptionCount').text('0');
      $('#deviseSymbole').text('Ar');
      $('#tarifModal').modal('show');
    }

    // Voir détails
    function viewTarif(id) {
      $.get(`/api/tarifs-publicite/${id}`, function(tarif) {
        $('#viewTarifId').text(tarif.id);
        
        const symbole = tarif.refDeviseSymbole || tarif.refDeviseCode;
        $('#viewMontant').html(`<strong class="text-success">${formatMontant(tarif.montant)} ${symbole}</strong>`);
        $('#viewDevise').text(`${tarif.refDeviseCode} - ${tarif.refDeviseLibelle}`);
        
        let statut = '';
        if (tarif.estActuel) {
          statut = '<span class="badge badge-success badge-lg"><i class="fas fa-star"></i> Tarif Actuel</span>';
        } else if (tarif.estEnVigueur) {
          statut = '<span class="badge badge-primary badge-lg">En Vigueur</span>';
        } else {
          statut = tarif.actif 
            ? '<span class="badge badge-secondary badge-lg">Historique</span>'
            : '<span class="badge badge-dark badge-lg">Inactif</span>';
        }
        $('#viewStatut').html(statut);
        
        $('#viewDateDebut').text(formatDate(tarif.dateDebut));
        $('#viewDateFin').html(tarif.dateFin 
          ? formatDate(tarif.dateFin) 
          : '<span class="badge badge-actuel">Pas de date de fin</span>');
        
        const duree = tarif.nombreJoursValidite 
          ? `${tarif.nombreJoursValidite} jours` 
          : '<strong>Illimité</strong>';
        $('#viewDuree').html(duree);
        
        $('#viewDescription').text(tarif.description || 'Aucune description');
        $('#viewCreatedAt').text(formatDateTime(tarif.createdAt));
        
        currentTarifId = id;
        $('#viewTarifModal').modal('show');
      });
    }

    // Modifier depuis la vue
    function editTarifFromView() {
      $('#viewTarifModal').modal('hide');
      editTarif(currentTarifId);
    }

    // Modifier
    function editTarif(id) {
      $.get(`/api/tarifs-publicite/${id}`, function(tarif) {
        currentTarifId = id;
        $('#tarifId').val(tarif.id);
        $('#refDeviseId').val(tarif.refDeviseId);
        $('#montant').val(tarif.montant);
        $('#dateDebut').val(tarif.dateDebut);
        $('#dateFin').val(tarif.dateFin || '');
        $('#description').val(tarif.description || '');
        $('#actif').prop('checked', tarif.actif);
        $('#descriptionCount').text((tarif.description || '').length);
        
        // Mettre à jour le symbole
        const selectedOption = $('#refDeviseId').find('option:selected');
        const symbole = selectedOption.data('symbole') || tarif.refDeviseSymbole || 'Ar';
        $('#deviseSymbole').text(symbole);
        
        $('#tarifModalTitle').html('<i class="fas fa-edit"></i> Modifier le Tarif #' + id);
        $('#tarifModal').modal('show');
      });
    }

    // Enregistrer
    function saveTarif() {
      const form = $('#tarifForm')[0];
      
      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
      }
      
      const tarifId = $('#tarifId').val();
      const isEdit = tarifId !== '';
      
      const data = {
        refDeviseId: parseInt($('#refDeviseId').val()),
        montant: parseFloat($('#montant').val()),
        dateDebut: $('#dateDebut').val(),
        dateFin: $('#dateFin').val() || null,
        description: $('#description').val() || null,
        actif: $('#actif').is(':checked')
      };
      
      const url = isEdit ? `/api/tarifs-publicite/${tarifId}` : '/api/tarifs-publicite';
      const method = isEdit ? 'PUT' : 'POST';
      
      $.ajax({
        url: url,
        type: method,
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function() {
          $('#tarifModal').modal('hide');
          loadTarifs();
          loadTarifActuel();
          showAlert('success', isEdit ? 'Tarif modifié avec succès' : 'Tarif créé avec succès');
        },
        error: function(xhr) {
          const message = xhr.responseJSON?.message || 'Une erreur est survenue';
          showAlert('danger', message);
        }
      });
    }

    // Confirmer suppression
    function confirmDeleteTarif(id, info) {
      $('#deleteTarifId').val(id);
      $('#deleteTarifInfo').text(info);
      $('#deleteTarifModal').modal('show');
    }

    // Supprimer
    function deleteTarif() {
      const id = $('#deleteTarifId').val();
      
      $.ajax({
        url: `/api/tarifs-publicite/${id}`,
        type: 'DELETE',
        success: function() {
          $('#deleteTarifModal').modal('hide');
          loadTarifs();
          loadTarifActuel();
          showAlert('success', 'Tarif supprimé avec succès');
        },
        error: function(xhr) {
          const message = xhr.responseJSON?.message || 'Impossible de supprimer ce tarif';
          showAlert('danger', message);
        }
      });
    }

    // Désactiver
    function desactiverTarif(id) {
      if (!confirm('Voulez-vous désactiver ce tarif ?')) return;
      
      $.ajax({
        url: `/api/tarifs-publicite/${id}/desactiver`,
        type: 'PUT',
        success: function() {
          loadTarifs();
          showAlert('success', 'Tarif désactivé avec succès');
        },
        error: function(xhr) {
          const message = xhr.responseJSON?.message || 'Erreur lors de la désactivation';
          showAlert('danger', message);
        }
      });
    }

    // Clôturer le tarif actuel
    function cloturerTarifActuel() {
      const dateFin = prompt('Date de fin (YYYY-MM-DD) ou laisser vide pour utiliser hier :', '');
      if (dateFin === null) return;
      
      const url = dateFin 
        ? `/api/tarifs-publicite/actuel/cloturer?dateFin=${dateFin}`
        : '/api/tarifs-publicite/actuel/cloturer';
      
      $.ajax({
        url: url,
        type: 'PUT',
        success: function() {
          loadTarifs();
          loadTarifActuel();
          showAlert('success', 'Tarif actuel clôturé avec succès');
        },
        error: function(xhr) {
          const message = xhr.responseJSON?.message || 'Erreur lors de la clôture';
          showAlert('danger', message);
        }
      });
    }

    // Formatage
    function formatMontant(montant) {
      return new Intl.NumberFormat('fr-MG', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(montant);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('fr-FR');
    }

    function formatDateTime(dateTimeStr) {
      if (!dateTimeStr) return '-';
      const date = new Date(dateTimeStr);
      return date.toLocaleString('fr-FR');
    }

    // Afficher alerte
    function showAlert(type, message) {
      const alert = $(`
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          <strong>${type === 'success' ? 'Succès !' : 'Erreur !'}</strong> ${message}
          <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
          </button>
        </div>
      `);
      
      $('#container-wrapper').prepend(alert);
      setTimeout(() => alert.alert('close'), 5000);
    }
  </script>
</body>
</html>
